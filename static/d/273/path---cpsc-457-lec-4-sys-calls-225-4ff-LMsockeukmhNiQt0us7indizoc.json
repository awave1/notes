{"data":{"markdownRemark":{"html":"<p>OS provides services to application, e.g. access to hardware, via higher level abstractions, resource management. These OS services are accessible through <strong>system calls</strong>, aka kernel calls, usually handled via <strong>traps</strong> (software interrupts).</p>\n<h2>System Calls</h2>\n<p>When an application wants to access a service/resource of the system, the application must make an appropriate <strong>system call</strong>, call a routine by the OS. It is done using <strong>traps</strong>.</p>\n<p>Trap is a special CPU instruction that switches from user mode to kernel mode. A trap invokes a pre-defined trap handler, registered by kernel.</p>\n<p>Inside trap handler:</p>\n<ul>\n<li>OS saves application state</li>\n<li>OS does the requested operation</li>\n<li>OS switches back to user mode and restores application state</li>\n</ul>\n<p>From application perspective, making a system call is just like calling any other routine.</p>\n<p>System calls provide an interface to the services made available by OS:</p>\n<ul>\n<li>API provided by the OS</li>\n<li>Interface for system calls varies from OS to OS</li>\n</ul>\n<h3>Libraries and system calls</h3>\n<p>System calls are minimalistic and not easy to use. Usually they are implimented in assembly, optimized for performance. System call number and parameters usually passed in registers.</p>\n<div class=\"gatsby-highlight\" data-language=\"asm\"><pre class=\"language-asm\"><code class=\"language-asm\">mov eax, 4   ; system call # (sys_write)\nmov ebx, 1   ; fd = stdout\nmov edx, 4   ; message length\nmov ecx, msg ; pointer to message\nint 0x80     ; trap</code></pre></div>\n<p>Quite inconvenient to use from higher level languages. Preferred way to make system calls through higher-level wrappers, e.g. <code class=\"language-text\">libc</code>, <code class=\"language-text\">libstdc++</code>, <code class=\"language-text\">libc++</code>.</p>\n<p>A library can provide a set of functions (API). APIs hide implementation details of system calls, making system calls via wrappers is more convenient.</p>\n<h4>Example: <code class=\"language-text\">printf()</code></h4>\n<ul>\n<li><code class=\"language-text\">write()</code> prepares arguments in registers</li>\n<li><code class=\"language-text\">write()</code> calls the <code class=\"language-text\">write</code> system call</li>\n<li><code class=\"language-text\">write()</code> takes the value returned by <code class=\"language-text\">write</code> and passes back to the caller</li>\n</ul>\n<p><code class=\"language-text\">printf()</code> does some formatting and then system calls <code class=\"language-text\">write</code></p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7341b971a5632375016cb91395275689/ee358/lec4-printf.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 528px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 100.37878787878789%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAABzklEQVQ4y4WU2Q6CQAxF5///zGcfcIs77vuGAlpzmpRUAtikYRjaO7e9ZYI4+3w+xdPWdZbnubrPwUId4Gw2kyiKpNfrqcdxLO12WzqdjkynU7nf73K73SRN02ZA+0DSaDRSUEA2m41cr1d5PB7yer00JsuyYt3I8P1+y36/1wSc0tgrG2AeEK8FBARWTUa5xP1lmCSJXC4XWa/XMp/PZbvdKjjvq9VK/XA4aPl8M/a1DAEhiT4ul0s5n89yPB5lsVgoKAKx93w+pd/va28bAWFD8Ol0+js6VALTAtCa6RWGBUE8u92uMrN++jgAKZ0RagQkmZJRkH6amjbMpjyi0IofwKqSGRmAPIB3gHDEoH8MeAFID4bDofbCNmk0gGXzvyNrAGHnYwNqodput9MPnEb/YEDZ/C34ZDLRuPF4rM64EANjyACMB4JI4ImyBkap9AdhcAA4nIN55xsxEMAhgwd6gIr0DbP5+nfbmMHOj9ePKNCHCSwYaEowEUwcU9sb8cW/XB4ZSoE17zA1Re2mQQgbJ1t7QUPVXUgiCawB4z5stVoyGAxUHGsJMbD2GKEM5q8mgukp5TPs9Io1bDmImNobu+r6t1mzJwf4varcL8EIFoelcM5oAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"`printf()`\"\n        title=\"\"\n        src=\"/static/7341b971a5632375016cb91395275689/ee358/lec4-printf.png\"\n        srcset=\"/static/7341b971a5632375016cb91395275689/6d88e/lec4-printf.png 148w,\n/static/7341b971a5632375016cb91395275689/bd048/lec4-printf.png 295w,\n/static/7341b971a5632375016cb91395275689/ee358/lec4-printf.png 528w\"\n        sizes=\"(max-width: 528px) 100vw, 528px\"\n      />\n  </span>\n  </a></p>\n<h4>Syscalls in C</h4>\n<table>\n<thead>\n<tr>\n<th>call</th>\n<th>description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">fd = open(file, how, ...)</code></td>\n<td>open a file for reading, writing, or both</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">s = close(fd)</code></td>\n<td>close an open file</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">n = read(fd, buffer, nbytes)</code></td>\n<td>read data from a file into a buffer</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">n = write(fd, buffer, nbytes)</code></td>\n<td>write data from a buffer into a file</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">position = lseek(fd, offset, whence)</code></td>\n<td>move the file pointer</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">s = stat(name, &amp;buf)</code></td>\n<td>get file metainfo</td>\n</tr>\n</tbody>\n</table>\n<p>System calls can be traced using <code class=\"language-text\">strace</code> (linux) or <code class=\"language-text\">dtruss</code> (macos).</p>\n<!-- why open a file and then read it? -->\n<!--- open is more expensive, read reuses whatever open has done.-->\n<!--- convenience. Always read from the beginning of the file-->","frontmatter":{"date":"January 24, 2019","title":"System calls","tags":["cpsc457"]}}},"pageContext":{"prev":{"fields":{"slug":"/cpsc457/lec3-interrupts-traps-kernels-vms"},"frontmatter":{"published":true,"tags":["cpsc457"]}},"slug":"/cpsc457/lec4-sys-calls","next":{"fields":{"slug":"/cpsc413/lec2-algorithm-analysis"},"frontmatter":{"published":true,"tags":["cpsc413"]}},"category":"cpsc457"}}