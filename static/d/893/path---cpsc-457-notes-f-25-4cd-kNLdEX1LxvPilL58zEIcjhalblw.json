{"data":{"markdownRemark":{"html":"<p>TODO: Simple table of contents</p>\n<h1>Operating Systems: Introduction, History, Basic Concepts</h1>\n<p>Brief introduction to history of Operating Systems.</p>\n<h2>Defining an OS</h2>\n<p>There's no 'precise' definition. It is a layer of software that provides application programs with a better, simpler, cleaner model of the computer. The OS is there to simplify interaction with the hardware. OS manages all resources.</p>\n<p>It is the software that runs all the time (mostly in kernel mode). All other applications need it in order to run (<em>most</em> applications will need it).</p>\n<p>We can look at an OS from two different perspectives:</p>\n<ul>\n<li>an <strong>extended machine</strong></li>\n<li>as a <strong>resource manager</strong></li>\n</ul>\n<p>An OS presents an abstraction mechanism that lets you interact with the hardware.</p>\n<h3>OS - an extended machine</h3>\n<p>Abstraction / generalization is key to managing complexity. First we define and implement the abstractions. For example, files - working with files is easier than dealing with raw disk space. Then, using these abstractions, we write applications and solve problems (e.g. file editor, image viewer). An OS doesn't care what's in the file, it is up to the applications to determine how to use the file.</p>\n<p>The abstractions allow us to mask the ugly hardware and provide nice interfaces instead. Many OS concepts are abstractions, therefore there are some similarities to OOP.</p>\n<h3>OS - a resource manager</h3>\n<p>OS acts as a resource allocator. It multiplexes available resources.</p>\n<ul>\n<li>\n<p>Multiplexing resources in time</p>\n<ul>\n<li>e.g. 3 programs trying to print to the same printer (spooling)</li>\n<li>e.g. 2 programs trying to run at the same time (scheduling)</li>\n</ul>\n</li>\n<li>\n<p>Multiplexing resources in space</p>\n<ul>\n<li>e.g. 2 programs allocating memory</li>\n</ul>\n</li>\n</ul>\n<p>OS manages conflicts among multiple programs or users.</p>\n<!--IMPORTANT: syscalls need to be checked-->\n<p>We can also think about OS as a control program. It decides when to run which application. OS monitors improper use and prevents errors. OS is responsible for handling all interrupts and traps.</p>\n<h2>History of Operating Systems</h2>\n<p>OSes often developed by customers instead of HW manufacturers. IBM developed first OS in the 60's.</p>\n<h3>First Generation (1945 - 1955): Vacuum Tubes and no OS</h3>\n<p>Programs were hardwired, later were made on punch cards. Programs were written in machine language. Hardware required complicated wiring. Only single user at a time. Such computers were only able to perform basic calculations. No OS since there was no need for one.</p>\n<h3>Second Generation (1955 - 1965): Transistors and Batch Systems</h3>\n<p>Transistor based mainframe computers replaced old vacuum tube computers. Programs were made with FORTRAN &#x26; COBOL. OSes that were used: FMS (Fortran Monitor System) and IBSYS (IBM OS). Important concept was introduced: <strong>batch systems</strong>.</p>\n<h4>Batch Systems</h4>\n<p>The users of a batch operating system do not interact with the computer directly. Each user prepares his job on an off-line device like punch cards and submits it to the computer operator. To speed up processing, jobs with similar needs are batched together and run as a group. The programmers leave their programs with the operator and the operator then sorts the programs with similar requirements into batches.</p>\n<h3>Third Generation (1965 - 1980): ICs and Multiprogramming</h3>\n<p>Transistors were replaces with Integrated Circuits (ICs). Lots of OSes came out: IBM OS/360, CTSS (by MIT), MULTICS (complicated, but influential), UNIX (inspired by MULTICS). Important concepts:</p>\n<ul>\n<li><strong>multiprogramming</strong>: a different job in each memory partition, CPU execute other jobs, while waiting for the IO of some jobs. Multiple programs could sit in memory.</li>\n<li><strong>spooling</strong> (Simultaneous Peripheral Operation On Line): read jobs from cards to disk, load jobs from disk automatically, no more tapes.</li>\n<li><strong>time-sharing</strong>: multiple users using one computer simultaneously and interactively. Terminals were connected to a central server.</li>\n</ul>\n<h4>Multiprogramming</h4>\n<p>Refers to the idea, if you have more than one program in the memory, processor will switch between the programs when one program is idle.</p>\n<h4>Spooling</h4>\n<p>Spooling is typically used to deal with slow devices/peripherals, e.g. printer. Spooling can be used to deal (somewhat) with deadlocks in concurrent programming.</p>\n<h3>Fourth Generation (1990 - Now): Personal Computers</h3>\n<p>Cheap, mass-produced computers, User friendly interfaces on top of OS.</p>\n<hr>\n<h1>Hardware, Cache, Booting, Kernel</h1>\n<p>Overview of hardware &#x26; how OS is interacting with it.</p>\n<h2>Hardware Review</h2>\n<p>A typical computer contains of several components that are interconnected through a bus.</p>\n<h3>CPU</h3>\n<p>CPU is the \"brain\" of the computer. It contains different types of registers (registers - very fast memory):</p>\n<ul>\n<li>\n<p>On-board registers for faster computation.</p>\n<ul>\n<li>Instead of accessing memory for every instruction</li>\n<li>Accessing information in registers is faster than memory</li>\n</ul>\n</li>\n<li>\n<p>General purpose registers</p>\n<ul>\n<li>Data &#x26; address</li>\n</ul>\n</li>\n</ul>\n<p>A simple CPU cycle:</p>\n<ol>\n<li><strong>Fetch</strong> an instruction</li>\n<li><strong>Decode</strong> it to determine its type and operands</li>\n<li><strong>Execute</strong> it</li>\n</ol>\n<p>Steps are repeated for the next instruction, until program finishes.</p>\n<p>However, there is a performance issue: fetching from memory takes longer than executing an instruction. A solution would be to <strong>pipeline</strong> the opertaions:</p>\n<h4>CPU Pipelining</h4>\n<ul>\n<li>while executing instruction <code class=\"language-text\">N</code>,</li>\n<li>the CPU could be simultaneously decoding instruction <code class=\"language-text\">N + 1</code>,</li>\n<li>and at the same time also fetch instruction <code class=\"language-text\">N + 2</code></li>\n</ul>\n<p>Therefore fetch-execute cycle can be done in parallel. Parallelized app will be as fast as slowest link of the pipeline. Three stage pipeline:</p>\n<div class=\"gatsby-highlight\" data-language=\"mermaid-svg\"><pre class=\"language-mermaid-svg\"><code class=\"language-mermaid-svg\">graph LR\n  A[Fetch Unit]--&gt;B[Decode Unit]\n  B--&gt;C[Execute Unit]</code></pre></div>\n<p>Pros:</p>\n<ul>\n<li>the CPU can execute more than one instruction at a time</li>\n<li>'hide' the memory access time</li>\n</ul>\n<p>Cons:</p>\n<ul>\n<li>more complexity</li>\n</ul>\n<h3>Memory</h3>\n<p>Ideally, memory should be (i) fast, (ii) large and (iii) cheap. In practice, we can get 2 out of 3, but not all three.</p>\n<p>Main memory is RAM (Random Access Memory). Memory is a accessible big array of bytes. Memory operations:</p>\n<ul>\n<li><strong>load</strong>: moves a word from memory to a CPU register</li>\n<li><strong>store</strong>: moves a content of a register to memory</li>\n</ul>\n<p>Both load and store operations are slow compared to the speed of CPU.</p>\n<h2>Caching</h2>\n<p>CPU caching is the process of most heavily used data from memory is kept in a high-speed cache inside or very close to the CPU. When CPU needs to get data from memory, it first checks the cache:</p>\n<ul>\n<li>\n<p><strong>cache hit</strong>: the data needed by the CPU is in the cache</p>\n  <!--or-->\n</li>\n<li><strong>cache miss</strong>: CPU needs to fetch the data from main memory</li>\n</ul>\n<p>CPU consists of multiple levels of caches:</p>\n<ul>\n<li>L1 cache (16kB): inside the CPU, usually feeds decoded instructions into CPU execution engine</li>\n<li>L2 cache (xMB): stores recently used memory words, slower than L1</li>\n<li>L3 and L4 are becoming common</li>\n</ul>\n<!--core is like a mini cpu-->\n<h3>Caching on multicore CPUs</h3>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/4d3db85953807fa906d525e8102cdec6/79964/lec2-caching1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 52.06611570247933%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACTklEQVQoz0WSX2vTUBjG9x0EP4F3foSBn8KhTK8G3rgbvfLCSy8cc45dDhQGIkMmCOIfnJSNucm2dl3pX9suSZOepEnTpE33B9uuzc+TZMND3veccB6e877P804hVyBU3C8fafstLEfB+7yBYyr45350TTiZxHu/qeK9f4tTL2Ne+Ljb3/E/fcDybbx+J8ZMhTKZ5TSNlWV0o0GlkcF4vYSSz2F4OmEoya4IW+kd3Nl79A72sAkwll/gzc8TnHYwXVViQ6ZkxuzJys66+J6F7pVx/wZYtqDpNggJScoMsQMH0evy47dKKlvDOrWpCpeNzSp5VY1AskKJt7oaqcwu3zLHpIo5vu4fsl04oNlV4ldjUvmZnpCt2cytVLj/6hDvVKOgOdx+nObdVilpeTIGf2DwYLXAzYfHTD8rceNRjadrafyLOuMxMWm0zHadP/lNylKWcrtE/WSPWnGLvJlDaVcTwihZeoHM+iqZeo6cekR2/Q2Z/C8MWXlc4ZWG9u5Punem6e/tIDhHPH9Cf2aG7lkP0VbjTmJTWsU09tIijm2iNrO4iy+lUSWELxJTwlgeHN9CaCrFokJN6IiWglZVKFR0GrZ+rWEotTI58V00Q6PSKqAGPoquoTtXGoaJhqLTpCNJZxfy3F04kHqqHFdNbs3ts5Yq/m85kPPmeAbtoEWr15TzKHB6pmwlma1rp/sXPeyuIKs2OVJ1iRfSKIudsobhugnhaDRiOBgmMYzOMoZDBoOBjGSfSA3H0p3oHOGYXMJ4FN9HWCYjLkfD+P8f3PTSSGXsKawAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Caching on multicore CPUs\"\n        title=\"\"\n        src=\"/notes/static/4d3db85953807fa906d525e8102cdec6/fb8a0/lec2-caching1.png\"\n        srcset=\"/notes/static/4d3db85953807fa906d525e8102cdec6/1a291/lec2-caching1.png 148w,\n/notes/static/4d3db85953807fa906d525e8102cdec6/2bc4a/lec2-caching1.png 295w,\n/notes/static/4d3db85953807fa906d525e8102cdec6/fb8a0/lec2-caching1.png 590w,\n/notes/static/4d3db85953807fa906d525e8102cdec6/526de/lec2-caching1.png 885w,\n/notes/static/4d3db85953807fa906d525e8102cdec6/fa2eb/lec2-caching1.png 1180w,\n/notes/static/4d3db85953807fa906d525e8102cdec6/08f6a/lec2-caching1.png 1770w,\n/notes/static/4d3db85953807fa906d525e8102cdec6/79964/lec2-caching1.png 2178w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<!--1. can process bigger chunks, bigger parts of the memory because L2 will be bigger-->\n<p>Caches can be shared and there are multiple ways of sharing cache.</p>\n<hr>\n<p>The goal of caching is to increase performance of slower memory/device by adding a small amount of fast memory (cache). Ways of improving read performance:</p>\n<ul>\n<li>keep copy of information obtained from slow storage in cache</li>\n<li>check cache on next read</li>\n</ul>\n<p>Improving write performance:</p>\n<ul>\n<li>write info to fast storage, and eventually write to slow storage</li>\n</ul>\n<p>Caching is a very useful concept. There are many uses: disk cache, DNS, databases.</p>\n<p>Cache storage is fast but expensive, so it's usually much smaller than the slow storage. Some general caching issues:</p>\n<ul>\n<li>when to put a new item into the cache</li>\n<li>which cache line to put the new item in</li>\n<li>which item to remove from the cache when it's full</li>\n<li>where to put a newly evicted item in the larger memory</li>\n<li>multiple cache synchronization</li>\n<li>how long is the data in cache valid</li>\n</ul>\n<h3>Memoization</h3>\n<p>It's a similar concept to caching. It can be used to speed up function that are slow to compute. Optimization technique used to speed up programs, by storing results of expensive computations.</p>\n<p>Unoptimized function:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">fib_slow</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">if</span> n <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> n\n  <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> fib_slow<span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> fib_slow<span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Optimized function:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">cache <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">fib_fast</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">if</span> n <span class=\"token operator\">not</span> <span class=\"token keyword\">in</span> cache<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> n <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span>\n      cache<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> n\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n      cache<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> fib_fast<span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> fib_fast<span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span></code></pre></div>\n<h2>Hardware I/O</h2>\n<p>I/O devices usually implemented in two parts: device controller and the device.</p>\n<p>A <strong>device controller</strong> is a chip or a set of chips that physically control the device. Controlling the device is complicated, and CPU could be doing other things, so the controller presents a simpler interface to the OS. A controller presents a unified interface of devices that it can support to the OS.</p>\n<p>A <strong>device</strong> connects to the computer through the controller. It follows some agreed standards for communication.</p>\n<p>A <strong>device driver</strong> is the software abstraction of the controller, the software that talks to a controller, issues commands and accepts responses. Usually is written by the manufacturer. Driver is needed so the OS knows how to communicate with the device.</p>\n<h2>Buses</h2>\n<p><strong>Bus</strong> is a communication system for transferring data between different computer components.</p>\n<h2>Booting Process</h2>\n<p>When the computer is booted, the BIOS is started. BIOS (Basic Input Output Program) is a program stored on motherboard.</p>\n<h2>Kernel</h2>\n<p>The central part, or the heart of the OS. Kernel is running at all times on the computer. It is located and started by a bootstrap program (bootloader). Kernel provides services to applications via system calls and handles all interrupts. Much of kernel is a set of routines, some invoked in response to interrupts, others because of application using system calls, etc.</p>\n<h3>Kernel mode</h3>\n<p>Most modern CPUs support at least two privilege levels: <strong>kernel mode</strong> and <strong>user mode</strong>. The mode is usually controlled by modifying the status register. On CPUs without this support, there's only kernel mode.</p>\n<p>When CPU is in <strong>kernel mode</strong>:</p>\n<ul>\n<li>all instructions are allowed</li>\n<li>all I/O operations are allowed</li>\n<li>all memory can be accessed</li>\n</ul>\n<!--not all kernel runs in kernel mode-->\n<p>When CPU is in kernel mode, every instruction are executed.</p>\n<h3>User mode</h3>\n<p>When OS runs a normal application, it runs it in a <strong>user mode</strong>. Only a subset of operations are allowed (e.g. accessing the status register is not allowed). I/O instructions are not allowed, access to some parts of memory is not allowed. Illegal instructions result in traps (exceptions).</p>\n<p>Applications that run in user mode must ask kernel to do I/O. Therefore, applications must invoke a <strong>system call</strong>, which is usually accomplished by invoking a <strong>trap</strong> into the OS.</p>\n<h4>Trap</h4>\n<p>Trap is a special asm instruction (<code class=\"language-text\">SWI n</code>, <code class=\"language-text\">INT n</code>, <code class=\"language-text\">TRAP n</code>). Trap switches from user mode to kernel mode and invokes a <strong>predefined routine</strong>. It 'pauses' the application to execute kernel routine configured by the OS. When kernel routine is done, user mode is restored and application 'resumes'.</p>\n<hr>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/8d89be046658dcbe0acd354f8bfd4e04/754de/lec2-kernel-user-mode.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 45.998240985048376%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABMElEQVQoz3VSh4qEMBD1//9OBJW1xAaWGPuJfc43Rw6Xuw0Ew2Ty2mhM00RSSsK3bVtSSvG5rmtqmobO86TruniP48i1ZVkIS9efyyjLkkzTZNDX60WWZTGY4zgUhiEdx/ELmuc5+b7PwE/A5za2baNhGLhhXVfq+57P+OIOTRoQyqD+ExgDQo3rumxFCMGqYBs1KAJZ13VMEAQBRVFE8zz/sfpmGTaSJCHP8/hBmqYUx/HbF/kCFMQgAakQIWVZdtcUqVreDhcydBMakKMeDBqLouAz7kGs736Go243/k0W35lLzpota+/7vvMDPIYiDAVDwhk1RKMfIVMQIB6orKryjuGL64b2jkZkgw11mDxyhEpdfy4ojETACqWsGBCExn//EtTYts0bqp+kn4ah1zdeUK/0/+Z77gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Kernel mode vs User mode\"\n        title=\"\"\n        src=\"/notes/static/8d89be046658dcbe0acd354f8bfd4e04/fb8a0/lec2-kernel-user-mode.png\"\n        srcset=\"/notes/static/8d89be046658dcbe0acd354f8bfd4e04/1a291/lec2-kernel-user-mode.png 148w,\n/notes/static/8d89be046658dcbe0acd354f8bfd4e04/2bc4a/lec2-kernel-user-mode.png 295w,\n/notes/static/8d89be046658dcbe0acd354f8bfd4e04/fb8a0/lec2-kernel-user-mode.png 590w,\n/notes/static/8d89be046658dcbe0acd354f8bfd4e04/526de/lec2-kernel-user-mode.png 885w,\n/notes/static/8d89be046658dcbe0acd354f8bfd4e04/fa2eb/lec2-kernel-user-mode.png 1180w,\n/notes/static/8d89be046658dcbe0acd354f8bfd4e04/08f6a/lec2-kernel-user-mode.png 1770w,\n/notes/static/8d89be046658dcbe0acd354f8bfd4e04/754de/lec2-kernel-user-mode.png 2274w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<!--true-->\n<!--true-->\n<!--most run in kernel, but some are in user mode-->\n<hr>\n<h1>Interrupts, traps, kernel design, VMs</h1>\n<h2>Interrupts</h2>\n<p>Interrupt can happen at any time. When interrupt happens, CPU switches to kernel mode and interrupt handler executes the interrupt. CPU state is saved by the interrupt handler before executing code in interrupt handler. After executing interrupt, CPU restores state and switches back to user mode. Source of the interrupts is usually devices.</p>\n<h3>Software interrupts (exception/traps)</h3>\n<p>Similar to hardware interrupts but the source of the interrupt is the CPU itself. Software interrupts are handled similarly to hardware interrupts.</p>\n<p>There are two types of software interrupts: <em>intentional</em> and <em>unintentional</em>.</p>\n<h4>Unintentional interrupts</h4>\n<p>Also called <strong>exceptions</strong>. Occurs when CPU executes invalid instruction (e.g. accessing non-existent memory, write to ROM, division by zero). Unintentional interrupts used by OS to detect when an application attempts an illegal operation.</p>\n<h4>Intentional interrupts (trap)</h4>\n<p>Trap usually occurs via special instruction, e.g. <code class=\"language-text\">INT</code>. The purpose of a trap is to execute predefined routine in <em>kernel mode</em>. OS can use traps to implement system calls.</p>\n<h3>Hardware interrupts vs Software interrupts</h3>\n<ul>\n<li>\n<p><strong>Hardware Interrupts</strong>:</p>\n<ul>\n<li>External event delivered to the CPU</li>\n<li>Origins: I/O, timer, user input</li>\n<li>Asynchronous with the current activity of the CPU</li>\n<li>The time of the event is not known and not predictable</li>\n</ul>\n</li>\n<li>\n<p><strong>Software Interrupts</strong>:</p>\n<ul>\n<li>Internal events, e.g. system calls, exceptions</li>\n<li>Synchronous with the current activity of the CPU</li>\n<li>Occurs as a result of execution of a machine instruction</li>\n</ul>\n</li>\n<li>\n<p>Both hardware and software interrupts:</p>\n<ul>\n<li>Invoke a kernel routine, defined by the OS</li>\n<li>Put the CPU in a kernel mode</li>\n<li>Save the current state of the CPU</li>\n<li>Eventually resume the original operations when done</li>\n</ul>\n</li>\n</ul>\n<h3>I/O</h3>\n<p>How does the kernel handle I/O? There are two options.</p>\n<ul>\n<li>\n<p><em>Option 1</em>: busy waiting/spinning/busy looping (aka polling).</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cpu -&gt; disk: read a file\nloop:\ncpu -&gt; disk: u done?\nbreak if done\ncpu -&gt; disk: give result</code></pre></div>\n<ul>\n<li>There are problems with is:</li>\n<li>the CPU is tied up while slow I/O completes the operation <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mtext>&ThickSpace;</mtext><mo>⟹</mo><mtext>&ThickSpace;</mtext></mrow><annotation encoding=\"application/x-tex\">\\implies</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.549em;vertical-align:-0.024em;\"></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">⟹</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span></span></span> CPU could be doing other operations</li>\n<li>Power is wasted</li>\n</ul>\n</li>\n<li>\n<p><em>Option 2</em>: busy wait with sleep</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cpu -&gt; disk: read a file\nloop:\nsleep\ncpu -&gt; disk: u done?\nbreak if done\ncpu -&gt; disk: give result</code></pre></div>\n<ul>\n<li>Sleep could be detected by OS and the CPU could then run another program</li>\n<li>Problems:</li>\n<li>Hard to estimate the right amount of sleep</li>\n<li>Program might end up running longer than necessary</li>\n</ul>\n</li>\n<li>\n<p><em>Option 3</em>: Hardware interrupts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cpu -&gt; disk: read a file\ncpu -&gt; disk: update when done\ncpu: sleep until interrupted\ndisk -&gt; cpu: interrupt\ncpu -&gt; disk: give result</code></pre></div>\n<ul>\n<li>When the I/O device finishes the operation, it generates an interrupt, letting the OS know it's done, or there was an error</li>\n<li>This approach assumes the I/O device supports interrupts</li>\n</ul>\n</li>\n</ul>\n<h4>Using interrupts to do I/O</h4>\n<p>Kernel talks to the device driver to request an operation. The device driver tells the controller what to do by writing into device registers. The controller starts the device and monitors its progress. When the device is done its job, the device controller signals the interrupt controller. The interrupt controller informs the CPU and puts the device information on the bus. The CPU suspends current process and handles the interrupt by executing the appropriate interrupt handler (in kernel mode). The CPU then resumes its original process.</p>\n<h3>Limits of interrupts</h3>\n<ul>\n<li>CPU can run other programs while waiting for I/O</li>\n<li>\n<p>CPU could be interrupted for every single byte of I/O</p>\n<ul>\n<li>many devices/controllers have limited memory</li>\n<li>these devices could generate an interrupt for every single input byte</li>\n<li>interrupts take many CPU cycles to save/restore CPU state</li>\n<li>useful work often a single instruction - to store the data in memory</li>\n</ul>\n</li>\n</ul>\n<p>To solve these problems, introduce a dedicated hardware to deal with interrupts - DMA chip</p>\n<ul>\n<li>DMA absorbs most interrupts</li>\n<li>DMA can save data directly into memory, without CPU knowing</li>\n<li>result is less interrupts for the CPU</li>\n</ul>\n<h4>Direct memory access (DMA)</h4>\n<p>It is a special piece of hardware on most modern systems. DMA used for bulk data movement such as disk I/O. It is usually used with slow devices so that CPU can do other things, but also could be used with extremely fast devices that could overwhelm CPU.</p>\n<p>Device controller transfers an entire block of data directly to the main memory without CPU intervention. Only one interrupt is generated per block - to tell the device driver that the operation has completed. Used for device <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding=\"application/x-tex\">\\to</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">→</span></span></span></span> memory, memory <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding=\"application/x-tex\">\\to</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">→</span></span></span></span> device, and memory <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding=\"application/x-tex\">\\to</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">→</span></span></span></span> memory transfers.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/54080e443e90f6a5fd10f10375cbad17/988e0/lec3-dma.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 52.85714285714286%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB8klEQVQoz4WT3WrUQBTH80Dee+creOcb+BKleqNiL7yQgogirrioiK6gti6IYLWliraFUuyitW7XzWaz2U2ymSQz+ZjM35OMu6ZS8cCP4Zzk/DkfM4YUCZQsUJpSqjrzLMfIdiDoWz3+t83inAtklFOa0XpxE3tfNrWQ1MG1rXVcurOEB6sPKSbnySdRWmd/D0PL1IK3Ghfw+ePLyimUTl7feYtr96/gyesmZCFn9dROdczf+fQBjj3Ugt6YIzbHEIkEFzl4UoBPI5gWQ5wpCIJn+CdJruCOBSKWoizYiKIMrhPCN114JX1i4MOxQnijElYjhGuzipk/dRgGZoDeMEZBqzBqI8bJpv6LUsWfpWScQ4Ts9wy1aJbn6P7swbJtnaL0UsrLMA44GPU6i5WWpiltmmvB9psmHj1brhxZ6OvT6X7F4o2LuNy4CssZzmtdaHVw6vwyTi+uYO1bMI8fdQ+xu7ulBTc2n6Pdvnesbcvpo7lyF49fNTANvXni2esbMM4swDh3G0+3hzXBH+h9P9CCBbU+mZQblgh5Qe1IiBTwImIkaBwpWJAgonN730brXR+r7w/RswJwWmjEBHw3wdjN6UFIGOWr8KcJmM8ReISv8d24IpiERFSdGc0vj1PItEDMEkzp/9AXVFCMowFDSlfsF6PgPBGPOVZCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"DMA\"\n        title=\"\"\n        src=\"/notes/static/54080e443e90f6a5fd10f10375cbad17/fb8a0/lec3-dma.png\"\n        srcset=\"/notes/static/54080e443e90f6a5fd10f10375cbad17/1a291/lec3-dma.png 148w,\n/notes/static/54080e443e90f6a5fd10f10375cbad17/2bc4a/lec3-dma.png 295w,\n/notes/static/54080e443e90f6a5fd10f10375cbad17/fb8a0/lec3-dma.png 590w,\n/notes/static/54080e443e90f6a5fd10f10375cbad17/526de/lec3-dma.png 885w,\n/notes/static/54080e443e90f6a5fd10f10375cbad17/988e0/lec3-dma.png 1120w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<hr>\n<h2>Kernel Designs</h2>\n<p>What goes into a kernel and what does not? There are trade-offs to consider:</p>\n<ul>\n<li>code in kernel runs faster, but</li>\n<li>big kernels have more bugs <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mtext>&ThickSpace;</mtext><mo>⟹</mo><mtext>&ThickSpace;</mtext></mrow><annotation encoding=\"application/x-tex\">\\implies</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.549em;vertical-align:-0.024em;\"></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">⟹</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span></span></span> higher system instability</li>\n</ul>\n<p>There are three main kernel designs: <strong>monolithic kernel</strong>(MS-DOS, Linux), <strong>microkernels</strong>(Mach, QNX), <strong>hybrid kernels</strong>.</p>\n<h4>Monolithic kernel</h4>\n<p>The entire OS runs as a single program in kernel mode. It is faster but more prone to bugs, harder to port, and potentially less stable.</p>\n<h4>Microkernel</h4>\n<p>Only essential components in kernel - running in kernel mode (essential = code that must run in kernel mode). The rest is implemented in user mode. Most likely will be less bugs, easier to port and extend, more stable, but slower.</p>\n<h4>Hybrid kernel</h4>\n<p>Trying to balance the cons/pros of monolithic kernels and microkernels</p>\n<hr>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/42ecb17845b89a0f7900a2a918f4fdf9/1fe1a/lec3-kernel-designs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 36.64179104477612%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAACA0lEQVQozyWPW0jTcRzFfz71VkERSEaJ0EP0EBVB0EMPQZnloNSV5rL0P5U5U0uTdJq4NtmshS3TvJF52e2/vzq1xog0NxRJ6UJ0kcoIosASTNB6+fSTDhwOnHP4XgQrRXTP6LgdTaF58iT2sSPMzhvgbylfvyu4ose5E0vFNZ4sNZmFhXxYLeHbD4Wm2Jqnk1kKTdETLC0WIuZjgrJGgaFOoFjjOGMReFTBymfBxBPBxXpBrl2q5DnZmR4X/H4veBYRnJVdo/Qv3BAUOgRvJgViIGETDfY+LM0Rqm+qVLdP0WM08LpLFqKJLIXMhKf3M/LuGlcbVDTPVj5NCXrVfRwq7kcb2k7L3EZeyOUvJ+TA1oR4LtmGUVpnUW6NoXR/oO5YPt1JgkdtiSyOFKDN7Mb3sYqcmhA19fEE5TXutG0Y96YSsu6iv30PkU4dgdzNiKI4+bJVo9gdw+wMU/bgLWVHszALgfNAEk87nLR1KHT6XFTV+jHv3ECFzMrXrcd28DAhZwVdlXa8feNYtuxARFruYcq7QnamGSWnFL3exN3K67y676a3toG0U2bOp5eTLTUv08SorZHn7ib6bA5OZ18mI6uE9KwiMvQFDDkcCCRGw4/x+H0EBzUe9vYw92V+zebn8hK+gBd1MIB/QFILssp//Fpexuf3EtRU1GAAVWZ/pP8PR3RqWNDmnVEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Kernel designs\"\n        title=\"\"\n        src=\"/notes/static/42ecb17845b89a0f7900a2a918f4fdf9/fb8a0/lec3-kernel-designs.png\"\n        srcset=\"/notes/static/42ecb17845b89a0f7900a2a918f4fdf9/1a291/lec3-kernel-designs.png 148w,\n/notes/static/42ecb17845b89a0f7900a2a918f4fdf9/2bc4a/lec3-kernel-designs.png 295w,\n/notes/static/42ecb17845b89a0f7900a2a918f4fdf9/fb8a0/lec3-kernel-designs.png 590w,\n/notes/static/42ecb17845b89a0f7900a2a918f4fdf9/526de/lec3-kernel-designs.png 885w,\n/notes/static/42ecb17845b89a0f7900a2a918f4fdf9/fa2eb/lec3-kernel-designs.png 1180w,\n/notes/static/42ecb17845b89a0f7900a2a918f4fdf9/08f6a/lec3-kernel-designs.png 1770w,\n/notes/static/42ecb17845b89a0f7900a2a918f4fdf9/1fe1a/lec3-kernel-designs.png 2680w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<h3>Kernel modules</h3>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/d9b28e826c8238010a24054e6340593e/c664d/lec3-kernel-module.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 338px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 91.71597633136095%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAACDElEQVQ4y4WU16qqQQyFff9H8VoUFURFBduFDRRRsffeazZfNpH59Rz2QJi+spKVGd/1epX9fv+28/nssePx+N47HA7yeDyE9nq91D6bb71ey3w+l8ViIavVSur1ujQaDWm329JqtaTX6+n6crmU6XSqDv4E5AI9LLLZrAQCAYlEIhIMBhWc9c1mo04/AT/NB1i/35fhcCiDwUBGo5GMx2PtJ5OJjtljzv7pdJL/NQW83W7Kbrfb6YVqtSrdbleazaauE6qFzPx+v2seP+35fP6G7HpgY7vdCk4wBGOOMwRBJHoz0oATM+743OQCABs2YNvpdJQZoOl0WkKhkGQyGUkkEpLL5TQa0gUwwpJfDyBABkiuAMUzgCgOSLFYVOFKpZKCzWYzL6Al0wABuFwuOgeISwAjDpcpHesRyhVTQ/4XIKHTEMAtahuTU8urzU39L0ALmeaqC0NYERpmhW4Pgh7RPICmKrkgFPJGfmCSTCbF7/dLNBrVwo/FYpJKpfQcDK3oPYDkDi806gomxoyL9hypURuzbvkk7C9A9yUwNhEwe/OumUCkABJfgKaw5dSEYJ25nfn8jewn8gByAE9csDcOC0Qpl8uSz+elUqloDfIr1Wo1DZmzMP0KGcqAUS6A2CvAOwWNGPF4XMLhsIpUKBTeokDkLYoL6jY881HwJ/LzuIXNHKOo2cc5ZH4APh9U7HfCPXIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Kernel modules\"\n        title=\"\"\n        src=\"/notes/static/d9b28e826c8238010a24054e6340593e/c664d/lec3-kernel-module.png\"\n        srcset=\"/notes/static/d9b28e826c8238010a24054e6340593e/090cd/lec3-kernel-module.png 148w,\n/notes/static/d9b28e826c8238010a24054e6340593e/24e39/lec3-kernel-module.png 295w,\n/notes/static/d9b28e826c8238010a24054e6340593e/c664d/lec3-kernel-module.png 338w\"\n        sizes=\"(max-width: 338px) 100vw, 338px\"\n      />\n  </span>\n  </a></p>\n<p>Modular kernels are type of hybrid kernels, usually consist of smaller kernel with only essential components plus non-essential, dynamically loadable kernel parts - <strong>kernel modules</strong>. Drivers are often implemented as modules.</p>\n<p>Modules are often loaded on demand, when needed or requested. It could be at boot time or later. Modules usually run in kernel mode.</p>\n<ul>\n<li>OS can come with many drivers but only those that needed are loaded which results in faster boot time</li>\n<li>No kernel recompile/reboot necessary to activate a module</li>\n</ul>\n<h3>Layered approach</h3>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/8b7143b183752d1aa2e9eb187a860181/8cc2a/lec3-kernel-layers.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 224px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 186.60714285714286%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAlCAYAAABCr8kFAAAACXBIWXMAABYlAAAWJQFJUiTwAAADeklEQVRIx6VWaU8iQRDl17tx/eoXdXch6ipfTDxI0AhEE4+YNVESrywoIAwowgynoBy19RpqbIbhWJ3k0TPNm+7q7lf1xtPtdqnRaFCtVhtAtVodCScXeH9/J1yet7c3en5+pmKxSIVCQQH3pmkqlMtlsiyLKpWKavGsc3UgOA+ie3p6UmQZBC/E43HKZrN0e3tL6XSaotEoPT4+0sXFBRmGQaVSaWBiBNXpdD4GlIEwEwY/ODigjY0NmpubI7/fT99mZigWi9Hp6SklEgl7QEE+n/+IEKNjSSABWBYGRn+Go0txZNIPCE+HHSE2M5lM0sPDwwDQB6QyGcqiBScxzEO09/f3lMvleoeCH0Sph6+Aw+Gl5zm69I8lMgI76nmI19/HVqvVGxDrHnvx/6Xfq/R6ckKTLrWH+BkFXJ3XVyr++kmVcMh+aRw8QkLI7XbbhnrmTW7xdpi83Or5ObWZi34nF5DLgwddgwJL9gstJAUOAyfq5IOHDFIDOnWo6woSARGSQnqZ3A+x4z8nH7IZyBSdgHsIGPD5fLS/v0/z8/N0fX1NgUBAtZhEuK7C1peBZV1dXdHh4SFtb29TOBSiSCRCGdbkCZ82WnD0ZWNAO/VAeHl5UZ0CzCrZUUL14dNG9uBlnSv3ELYtGzwgT6F4FAUB+v6if2+PYsfHFOfMiPOzzhFgcjtTxl0dPpTi0iJVd3e/Luxun2T616l2dtZ7ifdpXCJMjhCnyRFWdoPTR9hsNl3Leg3lvl4ni4tsictYjQ/w0xYgMlJ1Ei/xKVuaJQhPf2+kBQB3d3eq/+bmhpJc8y4vL5UVHB0dqRoo3jKVBeAeAt7a2lIWsL62Rt9nZ5W/QODwF0SuRzmUKXppBxmTICKDRW9w/sry8eJEC5AyrgN9sIBEKkVpWAI/x7WSrwPCHrIAKVkCtTc8cyFrkOHzUo5lY/Iq9PImPEQ4vQWgXq6uUJ0P478yRTr0P5WwYWCwgEh4wAKcvCELcJb0tmYB1g4s4I+ygLZL+Xe1AF1Toyyg6Cj7X7MAbi3Nl/VBp7KAM64uEPfy8jKFw2FaXFhQWeP1elUWiQW4eoqbBSAb8MG0ublJIbaAYDCoDAr98vU11gKQRijnAvkmLPe1V+eqA47ksM7FYJhswAKgdlG9tLCAWL/kO1tntgxZwKRPjEmfLK7C/uylj/EPtxDpootqi4UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Kernel layers\"\n        title=\"\"\n        src=\"/notes/static/8b7143b183752d1aa2e9eb187a860181/8cc2a/lec3-kernel-layers.png\"\n        srcset=\"/notes/static/8b7143b183752d1aa2e9eb187a860181/61446/lec3-kernel-layers.png 148w,\n/notes/static/8b7143b183752d1aa2e9eb187a860181/8cc2a/lec3-kernel-layers.png 224w\"\n        sizes=\"(max-width: 224px) 100vw, 224px\"\n      />\n  </span>\n  </a></p>\n<p>Each layer only talk to layer below or above. Layer design is slow.</p>\n<h2>Virtual Machines</h2>\n<p>Virtual machines emulate computer systems either in software or in specialized hardware, or both. Host machine creates illusion that each guest machine has its own processor and its own hardware. <strong>Hypervisor</strong> - software or hardware that manages VMs. There are several types of hypervisors:</p>\n<ul>\n<li>\n<p>Bare metal - runs directly on hardware</p>\n<ul>\n<li>usually runs on big servers</li>\n<li>XEN, VMWare ESX</li>\n</ul>\n</li>\n<li>\n<p>Hosted - runs on top of another OS. Slower that bare metal, has to communicate with hardware through OS.</p>\n<ul>\n<li>Usually on desktops, slower</li>\n<li>VMWare Player, VirtualBox</li>\n</ul>\n</li>\n<li>Hybrid - using kernel itself as a hypervisor through a KVM module.</li>\n</ul>\n<p>Virtual machines can save money for companies, time for developers. VMs are isolated from each other, that means a user can run different versions of same program, or run unsafe programs. VMs are perfect solution for sys admins: there's no need to setup multiple servers, instead one big server can be setup with multiple VMs. That makes it easier to maintain.</p>\n<!--Containers do not virtualize the machine, containers virtualize the OS. \"each user app has it's own os\"-->\n<hr>\n<h1>System calls</h1>\n<p>OS provides services to application, e.g. access to hardware, via higher level abstractions, resource management. These OS services are accessible through <strong>system calls</strong>, aka kernel calls, usually handled via <strong>traps</strong> (software interrupts).</p>\n<h2>System Calls</h2>\n<p>When an application wants to access a service/resource of the system, the application must make an appropriate <strong>system call</strong>, call a routine by the OS. It is done using <strong>traps</strong>.</p>\n<p>Trap is a special CPU instruction that switches from user mode to kernel mode. A trap invokes a pre-defined trap handler, registered by kernel.</p>\n<p>Inside trap handler:</p>\n<ul>\n<li>OS saves application state</li>\n<li>OS does the requested operation</li>\n<li>OS switches back to user mode and restores application state</li>\n</ul>\n<p>From application perspective, making a system call is just like calling any other routine.</p>\n<p>System calls provide an interface to the services made available by OS:</p>\n<ul>\n<li>API provided by the OS</li>\n<li>Interface for system calls varies from OS to OS</li>\n</ul>\n<h3>Libraries and system calls</h3>\n<p>System calls are minimalistic and not easy to use. Usually they are implimented in assembly, optimized for performance. System call number and parameters usually passed in registers.</p>\n<div class=\"gatsby-highlight\" data-language=\"asm\"><pre class=\"language-asm\"><code class=\"language-asm\">mov eax, 4   ; system call # (sys_write)\nmov ebx, 1   ; fd = stdout\nmov edx, 4   ; message length\nmov ecx, msg ; pointer to message\nint 0x80     ; trap</code></pre></div>\n<p>Quite inconvenient to use from higher level languages. Preferred way to make system calls through higher-level wrappers, e.g. <code class=\"language-text\">libc</code>, <code class=\"language-text\">libstdc++</code>, <code class=\"language-text\">libc++</code>.</p>\n<p>A library can provide a set of functions (API). APIs hide implementation details of system calls, making system calls via wrappers is more convenient.</p>\n<h4>Example: <code class=\"language-text\">printf()</code></h4>\n<ul>\n<li><code class=\"language-text\">write()</code> prepares arguments in registers</li>\n<li><code class=\"language-text\">write()</code> calls the <code class=\"language-text\">write</code> system call</li>\n<li><code class=\"language-text\">write()</code> takes the value returned by <code class=\"language-text\">write</code> and passes back to the caller</li>\n</ul>\n<p><code class=\"language-text\">printf()</code> does some formatting and then system calls <code class=\"language-text\">write</code></p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/7341b971a5632375016cb91395275689/ee358/lec4-printf.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 528px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 100.37878787878789%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAABzklEQVQ4y4WU2Q6CQAxF5///zGcfcIs77vuGAlpzmpRUAtikYRjaO7e9ZYI4+3w+xdPWdZbnubrPwUId4Gw2kyiKpNfrqcdxLO12WzqdjkynU7nf73K73SRN02ZA+0DSaDRSUEA2m41cr1d5PB7yer00JsuyYt3I8P1+y36/1wSc0tgrG2AeEK8FBARWTUa5xP1lmCSJXC4XWa/XMp/PZbvdKjjvq9VK/XA4aPl8M/a1DAEhiT4ul0s5n89yPB5lsVgoKAKx93w+pd/va28bAWFD8Ol0+js6VALTAtCa6RWGBUE8u92uMrN++jgAKZ0RagQkmZJRkH6amjbMpjyi0IofwKqSGRmAPIB3gHDEoH8MeAFID4bDofbCNmk0gGXzvyNrAGHnYwNqodput9MPnEb/YEDZ/C34ZDLRuPF4rM64EANjyACMB4JI4ImyBkap9AdhcAA4nIN55xsxEMAhgwd6gIr0DbP5+nfbmMHOj9ePKNCHCSwYaEowEUwcU9sb8cW/XB4ZSoE17zA1Re2mQQgbJ1t7QUPVXUgiCawB4z5stVoyGAxUHGsJMbD2GKEM5q8mgukp5TPs9Io1bDmImNobu+r6t1mzJwf4varcL8EIFoelcM5oAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"`printf()`\"\n        title=\"\"\n        src=\"/notes/static/7341b971a5632375016cb91395275689/ee358/lec4-printf.png\"\n        srcset=\"/notes/static/7341b971a5632375016cb91395275689/6d88e/lec4-printf.png 148w,\n/notes/static/7341b971a5632375016cb91395275689/bd048/lec4-printf.png 295w,\n/notes/static/7341b971a5632375016cb91395275689/ee358/lec4-printf.png 528w\"\n        sizes=\"(max-width: 528px) 100vw, 528px\"\n      />\n  </span>\n  </a></p>\n<h4>Syscalls in C</h4>\n<table>\n<thead>\n<tr>\n<th>call</th>\n<th>description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">fd = open(file, how, ...)</code></td>\n<td>open a file for reading, writing, or both</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">s = close(fd)</code></td>\n<td>close an open file</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">n = read(fd, buffer, nbytes)</code></td>\n<td>read data from a file into a buffer</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">n = write(fd, buffer, nbytes)</code></td>\n<td>write data from a buffer into a file</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">position = lseek(fd, offset, whence)</code></td>\n<td>move the file pointer</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">s = stat(name, &amp;buf)</code></td>\n<td>get file metainfo</td>\n</tr>\n</tbody>\n</table>\n<p>System calls can be traced using <code class=\"language-text\">strace</code> (linux) or <code class=\"language-text\">dtruss</code> (macos).</p>\n<!-- why open a file and then read it? -->\n<!--- open is more expensive, read reuses whatever open has done.-->\n<!--- convenience. Always read from the beginning of the file-->\n<hr>\n<h1>Processes</h1>\n<p>Process is a key concept in all operating systems. A quick definition of a process is <mark>a program in execution</mark>. Process is associated with:</p>\n<ul>\n<li>an address space</li>\n<li>set of resources</li>\n<li>program counter, stack pointer</li>\n<li>unique ID (process ID, <strong>PID</strong>)</li>\n</ul>\n<p>Process can be though of as a container that holds all information needed by an OS to run a program.</p>\n<h2>Process Tree</h2>\n<p>Processes are allowed to create new processes.</p>\n<h2>Pipes</h2>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/cf22c70cb9dd12a15b076088107dbe51/4a6b5/lec5-pipe.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 37.920489296636084%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABWUlEQVQoz41Sa2+CUAzl//+jJXzYmAoiY/LwwRAEJANEhWVbJDw8o900mizLTtJc2tuenvYiqKqGeBNh5fnwPA++v0bTtiCcTid0Xcfn2QhNU2M4GMJ1V4iiiOucFxdZtoUQhRvomob7BwmWacG0bFR1g9/xTVjXNcIgxHodYDQcQZZlTKcm+0KSvHKHOI77ju5N+VtZQH/Ssc1y5HmOtu1Y8Vk95VOd7/tIkoTjwmKxuBDsdjtc+9XxiLk9h/w4wvPUuGnmOA7SNL34y+WSSYW277hNEzwOZL4g+ZIkYTweQ1VV6LrOMa1fi6IomEwmEEWxjymcL96J8PwQVXXkSYX9fs8X7x+ffBLRbDbjjqSW7PqblFmWxeSEsijR9aulldDogmEYLLUoCti23b9Uhv+ACIi4LEse3TTNXmUFgV6Mnj4MQxwOB06mxf9l7c9vRSKCIOB6IiN8AQIMVE/lrwPCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Pipe process\"\n        title=\"\"\n        src=\"/notes/static/cf22c70cb9dd12a15b076088107dbe51/fb8a0/lec5-pipe.png\"\n        srcset=\"/notes/static/cf22c70cb9dd12a15b076088107dbe51/1a291/lec5-pipe.png 148w,\n/notes/static/cf22c70cb9dd12a15b076088107dbe51/2bc4a/lec5-pipe.png 295w,\n/notes/static/cf22c70cb9dd12a15b076088107dbe51/fb8a0/lec5-pipe.png 590w,\n/notes/static/cf22c70cb9dd12a15b076088107dbe51/4a6b5/lec5-pipe.png 654w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>Pipes is a very powerful thing in Unix. On Unix systems, two processes can communicate with each other via a <strong>pipe</strong>. Pipes are accessed using file I/O APIs. Pipes <em>can</em> be bidirectional, but normally used as one directional.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">ls</span> -altr <span class=\"token operator\">|</span> <span class=\"token function\">tail</span> -10</code></pre></div>\n<p>Pipes allow parallelization: two programs will be executed in parallel.</p>\n<h2>Unix file APIs</h2>\n<p>Unix-like OSs make use of files and associated APIs for different operations/services. For example, if pipes are used programmatically, pipe will be used as some file.</p>\n<hr>\n<p>We want the ability to run multiple programs at the same time, aka <mark>multitasking</mark>. For this we need firm control and compartmentalization of the various programs. To this end we create an abstraction of <strong>program in execution</strong> and call it a <strong>process</strong>.</p>\n<h2>Multitasking</h2>\n<p>Process abstraction is used to implement <strong>multitasking</strong>. Multitasking allows an <strong>illusion</strong> of parallelism:</p>\n<ul>\n<li>running <code class=\"language-text\">N</code> processes with <code class=\"language-text\">M</code> CPUs, <code class=\"language-while n \"> M</code></li>\n<li>\n<p>works even with a single CPU:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">run program (i) for a fraction of a second\nswitch to program (i+1)\nrepeat</code></pre></div>\n</li>\n</ul>\n<p>Multitasking allows us to reduce CPU idling during I/O. CPU could be given to another process rather than remain idle. Multitasking is only practical when memory is big enough to hold multiple programs.</p>\n<p><strong>Program <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi mathvariant=\"normal\">≠</mi></mrow><annotation encoding=\"application/x-tex\">\\neq</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mrel\"><span class=\"mrel\"><span class=\"mord\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"rlap\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"inner\"><span class=\"mrel latin_fallback\"≯</span></span><span class=\"fix\"></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span></span><span class=\"mrel\">=</span></span></span></span></span> Process</strong>:</p>\n<ul>\n<li>\n<p>A <em>program</em> is a <strong>passive</strong> entry</p>\n<ul>\n<li>an executable file containing a list of instructions, usually stored on disk</li>\n</ul>\n</li>\n<li>\n<p>A <em>process</em> is an <strong>active</strong> entity</p>\n<ul>\n<li>associated with a <em>program counter</em> and other resources</li>\n</ul>\n</li>\n</ul>\n<h2>A process in memory</h2>\n<p>Each process gets its own <strong>address space</strong>. Part of memory available to a process, decided by OS. On modern OSes it is a <em>virtual</em> address space (0 - max), isolated from other processes.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/5a9af13c99a58a73bb6a32989f54b68e/9f11a/lec5-mem-stack.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 434px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 140.55299539170508%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAABYlAAAWJQFJUiTwAAADEklEQVRIx6VWTXPaMBTk9/eYWw+5pjSn0KSdIZcmLfXUpOFzCAFjYoNtDOYbAiWTZKtVRmAbp5NOmdl5kvZp9Z4kP5F6fHzEw8NDIjabzRZJ3NPTE4bDITRNw+XlJRqNBlJBEKDT6aDX68HzvC3YpzN52jhPuK4Ly7Jk2zAM6ZOi82AwwGQywXg8lmCbY+VyWa5K6/u+GJ9GfNSC4V9qNBpJYjabYTqdSsf5fC5XPz4+RiaTwcnJicxisVhInn4Ehbkwf0z/+fkZKYZptFqwbVuGr2DbHXiCcxxHpmQLwShvwzRNdLtdKUgxGWHbDZC76eHKHCJvBFvoxgD51hBfcmXozUGEI64Ep932cWv5LxEqQcufQG/PUXJWKHTvBV5sUdhre4mDwyPk6j7K3gaFjuJXKAr/vLVE0xlFI7R6Y/w0Jyh2lkJgEUFBjB2mP0FrDMQC93uc3p6h2R0mCU7FhOXWsdDZtUvuWkacxOl387cJhm04orj9J8Fde/7/guHUyt7viMgbBV85FLF3mYtr5NuTxC1IPhRxbfJipbK7kifJ60Arr5GY9O7gPb7XXFR6mx0vQP6XuFZG/Nq0nABfqx60ZoAft4MXiGuSkzbAx6yGb+Lis81x5aOJ/kXNR+0udrHdno+6cQfTdtCyuluw3/H6MNrik3R6MK0YL/oNU3yCXScaIYvDaBhgPptiNp1IsD0UVeSmVhPfawum+NbHIxaQnc+MhWQ8EtVmEBX8W/k6O/uMo6MPSKfTskCoChMuX6rabAU5wIrS7/dlzVNgn7WObZayMKd4VYgjgiTb7bYUZSkKQ03konGOYBnjvL09ZCSquIbBSl0oFFAsFkG/sA/bHNtL+TVBjp+fn8uKfXp6KqNVexj22RNkSgyd+8TwFdhX6RJJPJ8F2sRDoaWAAiNSadKq/QwjfijyTVEpq2ujLB8k7h/T1nVdPlzhdJOujRRMuodchAKVSgXZbBalUkm+iopPekYjh8LQ4ykTnEhhTo5zBAWr1Srq9fpWNMW/Iuv1OhGr1WqLJJ5/R7jH4bT/AEQqHwCJDyDEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Memory stack\"\n        title=\"\"\n        src=\"/notes/static/5a9af13c99a58a73bb6a32989f54b68e/9f11a/lec5-mem-stack.png\"\n        srcset=\"/notes/static/5a9af13c99a58a73bb6a32989f54b68e/47618/lec5-mem-stack.png 148w,\n/notes/static/5a9af13c99a58a73bb6a32989f54b68e/527c6/lec5-mem-stack.png 295w,\n/notes/static/5a9af13c99a58a73bb6a32989f54b68e/9f11a/lec5-mem-stack.png 434w\"\n        sizes=\"(max-width: 434px) 100vw, 434px\"\n      />\n  </span>\n  </a></p>\n<ul>\n<li><strong>text section</strong>: the program code</li>\n<li><strong>data section</strong>: global variables, constant variables</li>\n<li><strong>heap</strong>: memory for dynamic allocation during runtime</li>\n<li><strong>stack</strong>: temporary data (parameters, return address, local variables)</li>\n</ul>\n<p>Other information needed by the OS for management, usually grouped in a Process Control Block data structure.</p>\n<h3>Process control block</h3>\n<!-- NOTE: Remember what goes to PCB -->\n<p>Each process is represented in the OS by a PCB that includes:</p>\n<ul>\n<li>process state</li>\n<li>program counter</li>\n<li>CPU registers</li>\n<li>CPU-scheduling info priority, pointers to the queue, other parameters</li>\n<li>memory management info: page tables, segment tables, etc.</li>\n<li>accounting info: CPU time, timeout values, process numbers, etc.</li>\n<li>I/O status info: open files, I/O devices, etc.</li>\n</ul>\n<p>On Linux, <a href=\"https://github.com/torvalds/linux/blob/master/include/linux/sched.h\"><code class=\"language-text\">task_struct</code></a> is the <code class=\"language-text\">struct</code> that stores information about processes.</p>\n<p>The <strong>process table</strong> is a collection of all PCBs. Some of the fields of a PCB</p>\n<table>\n<thead>\n<tr>\n<th>Process management</th>\n<th>Memory management</th>\n<th>File management</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>program counter</td>\n<td>pointer to text segment</td>\n<td>root directory</td>\n</tr>\n<tr>\n<td>registers</td>\n<td>pointer to data segment</td>\n<td>working directory</td>\n</tr>\n<tr>\n<td>stack pointer</td>\n<td>pointer to stack segment</td>\n<td>file descriptors</td>\n</tr>\n<tr>\n<td>priority</td>\n<td>user ID</td>\n<td></td>\n</tr>\n<tr>\n<td>scheduling parameters</td>\n<td>parent ID</td>\n<td></td>\n</tr>\n<tr>\n<td>PID</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>parent process</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>process group</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>signals</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>process start time</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>CPU time used</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>children's CPU time used</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h2>Operations on processes</h2>\n<p>Processes need to be created and deleted dynamically and OS must provide mechanisms for this. Process creation on Unix is done via <code class=\"language-text\">fork()</code>:</p>\n<ul>\n<li><strong>parent process</strong> - the process that is creating a new process</li>\n<li><strong>child process</strong> - the newly created process</li>\n<li>processes in the system form a <strong>process tree</strong></li>\n<li>each process gets <strong>PID</strong>, a unique ID</li>\n</ul>\n<p>Process is executed via <code class=\"language-text\">fork()</code>:</p>\n<ul>\n<li>under Unix there's no difference, but under Win, there is (have to create <em>then</em> execute)</li>\n</ul>\n<p>Process termination is done via <code class=\"language-text\">exit()</code> or <code class=\"language-text\">kill()</code>:</p>\n<ul>\n<li>to let the OS delete the process</li>\n<li>termination can be (typically) only requested by the process or its parent</li>\n</ul>\n<p>There are other operations: synchronization, communication, etc.</p>\n<h2>Multiprocess program in C</h2>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Create &amp; run child process - duplicate of parent</span>\n  <span class=\"token function\">fork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Both parent and child will execute the next line</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"world.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There can be several possible outputs (due to buffering, or if <code class=\"language-text\">fork()</code> fails):</p>\n<ul>\n<li>\n<p>If <code class=\"language-text\">printf()</code> is unbuffered</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hello\nworld.\nworld.</code></pre></div>\n</li>\n<li>\n<p>If first process got interrupted, due to multitasking</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hello\nworwold.\nrld.</code></pre></div>\n</li>\n<li>\n<p>If <code class=\"language-text\">fork()</code> (returns <code class=\"language-text\">-1</code>) fails</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hello\nworld.</code></pre></div>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// create &amp; run child process - a duplicate of parent and remember the return value</span>\n  pid_t pid <span class=\"token operator\">=</span> <span class=\"token function\">fork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// both parent and child will execute the next line, but will have different value for pid</span>\n  <span class=\"token comment\">// 0 for child</span>\n  <span class=\"token comment\">// non-zero for parent</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PID: %d\\n\"</span><span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<!-- NOTE: what if fork is in a loop? -->\n<p>There also can be different outputs:</p>\n<ul>\n<li>\n<p>If parent was executed first</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">PID: 7\nPID: 0</code></pre></div>\n</li>\n<li>\n<p>If child was executed first</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">PID: 0\nPID: 7</code></pre></div>\n</li>\n<li>\n<p>If <code class=\"language-text\">fork()</code> failed</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">PID: -1</code></pre></div>\n</li>\n</ul>\n<hr>\n<!--fork urself, check if a child, exec a child-->\n<p>Executing a process by replacing the current process with a new process using <code class=\"language-text\">execl()</code>, <code class=\"language-text\">execlp()</code></p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// create and run child process - a duplicate of parent</span>\n  pid_t pid <span class=\"token operator\">=</span> <span class=\"token function\">fork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// both parent and child will execute this statement</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pid <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// error ocurred</span>\n    <span class=\"token function\">fprintf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stderr</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"fork failed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pid <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// child process</span>\n\n    <span class=\"token comment\">// replace process with `ls -l`</span>\n    <span class=\"token function\">execlp</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/bin/ls\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ls\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-l\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// parent process will wait for the child to complete</span>\n\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"waiting for child process: %d\\n\"</span><span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Another way of doing system calls is using <code class=\"language-text\">system()</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*\n    The system() library call uses fork() to create a child process that\n    executes the shell command\n  */</span>\n\n  <span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/bin/ls\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Process Tree</h2>\n<h2><code class=\"language-text\">init</code> Process</h2>\n<p><code class=\"language-text\">init</code> or <code class=\"language-text\">systemd</code> is the first process started after booting. Older Unix systems use <code class=\"language-text\">init</code>, but many popular Linux systems now switched to <code class=\"language-text\">systemd</code>. <code class=\"language-text\">init</code> is the ancestor of all user processes (direct or indirect parent), i.e. root of process tree. PID of <code class=\"language-text\">init</code> is always <code class=\"language-text\">PID = 1</code>. Orphaned processes are adopted by <code class=\"language-text\">init</code>. Process tree can be printed using following:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">pstree <span class=\"token comment\"># or</span>\n<span class=\"token function\">ps</span> axjf</code></pre></div>\n<p>Note: some special system 'processes', or kernel threads, are created by kernel during bootstrap, and do not have to be descendants of <code class=\"language-text\">init</code>, such as <code class=\"language-text\">swapper</code> and <code class=\"language-text\">pagedaemon</code>.</p>\n<!-- 1 cpu & 4 virtual PCs -->\n<!-- program becomes a process when it's *loaded* -->\n<h2>CPU utilization</h2>\n<p>Example: OS is running 4 processes, P1, P2, P3 and P4</p>\n<ul>\n<li>P1 spends 40% of the time waiting on I/O (idle bound)</li>\n<li>P2 spends 20% of the time waiting on I/O</li>\n<li>P3 spends 50% of the time waiting on I/O</li>\n<li>P4 spends 90% of the time waiting on I/O (cpu bound)</li>\n</ul>\n<p>If there is only one CPU, what will be CPU's utilization? i.e. what percentage of the time is the CPU going to be running 'something'?</p>\n<p>Answer: CPU utilization = probability that at least one of the processes is <em>not</em> waiting on I/O = 1 - (probability that all processes are waiting on I/O) = <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mn>1</mn><mo>−</mo><mo>(</mo><mn>0.4</mn><mo>⋅</mo><mn>0.2</mn><mo>⋅</mo><mn>0.5</mn><mo>⋅</mo><mn>0.9</mn><mo>)</mo><mo>=</mo><mn>0.964</mn><mo>=</mo><mn>96.4</mn><mi mathvariant=\"normal\">%</mi></mrow><annotation encoding=\"application/x-tex\">1 - (0.4 \\cdot 0.2 \\cdot 0.5 \\cdot 0.9) = 0.964 = 96.4\\%</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">9</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">9</span><span class=\"mord\">6</span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">9</span><span class=\"mord\">6</span><span class=\"mord\">.</span><span class=\"mord\">4</span><span class=\"mord\">%</span></span></span></span>.</p>\n<p>Assume <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.10903em;\">N</span></span></span></span> similar processes. Each process spends the same fraction <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>P</mi></mrow><annotation encoding=\"application/x-tex\">P</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span></span></span></span> of its time waiting on I/O, then:</p>\n<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mtext>CPU Utilization</mtext><mo>=</mo><mn>1</mn><mo>−</mo><msup><mi>P</mi><mi>N</mi></msup></mrow><annotation encoding=\"application/x-tex\">\\text{CPU Utilization} = 1 - P^{N}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">CPU Utilization</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8913309999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913309999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.10903em;\">N</span></span></span></span></span></span></span></span></span></span></span></span></span>\n<p>CPU utilization as a function of the number of processes in memory:</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/11e030fe68a03680750dc057cf730deb/652d4/lec6-cpu-util-graph.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 63.0695443645084%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABnUlEQVQ4y6VT0Y6CQAzk/z/Ne9BojIA5jAcKuCAsCsii9joNcOQOnm6TFdidtjPTahGvtm3p9Xrhld7vN00t3ONu7r4/t/CTZZkk7VdrDMWXC2mtSamEmsb8CX4+n8Mek7EUBwZBQMY0cliWJUVhSJ7nkff5SZvNhlbLFbmuQ7ZtUxRFlChFlzgWIgrvnGNIeL/fKY5iYVgUhQBw5vtfnGhJ6/Vakgd+QBUXA2vgzqcTJUlCaZpSnuc/CVElPIfCLOaqt9tNns3jIUValoSAkFln16uw0/xt2Bbs3rvBQ1QEGE9UUx19LDCBbJHKGBSCZ3MN6SSXQv3EPh6PR7mo65ol+pIQ8rUuhDlwD2beB4+7PjDMcy2muq4rsq8sC8ZPMZli9DuxVVU1N8Anx3aEARKOA8d7PItz24I8x3HoY7GgkuX9d8lgi/G7nXQTXURjMD5oEraMR5IO32qEAT7uZlIYIiGMN00jhsNHsEZDsiwXIJIU3RSgObAJU4E44HPG4GxgONUtADEuDjfrcDjQfr+nHavYbrccXM3+778BIO/ray4/QsAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"CPU utilization as a function of the number of processes in memory\"\n        title=\"\"\n        src=\"/notes/static/11e030fe68a03680750dc057cf730deb/fb8a0/lec6-cpu-util-graph.png\"\n        srcset=\"/notes/static/11e030fe68a03680750dc057cf730deb/1a291/lec6-cpu-util-graph.png 148w,\n/notes/static/11e030fe68a03680750dc057cf730deb/2bc4a/lec6-cpu-util-graph.png 295w,\n/notes/static/11e030fe68a03680750dc057cf730deb/fb8a0/lec6-cpu-util-graph.png 590w,\n/notes/static/11e030fe68a03680750dc057cf730deb/652d4/lec6-cpu-util-graph.png 834w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<h2>Resource allocation</h2>\n<p>There are several options for allocating resources for a new process:</p>\n<ul>\n<li>\n<p>child obtains resources directly from the OS</p>\n<ul>\n<li>most common and easiest to implement, most OS do this</li>\n<li><strong>drawback</strong>: something like 'for bomb' will destroy the system</li>\n</ul>\n</li>\n<li>\n<p>child obtains subset of parent's resources</p>\n<ul>\n<li>parent decides to give up some of its resources so that a child can use them</li>\n</ul>\n</li>\n<li>parent shares some/all resources with the child</li>\n</ul>\n<h3>Common parent-child execution scenarios</h3>\n<p>When child process is created, parent process usually does one of three things:</p>\n<ol>\n<li>\n<p>The parent waits until the child process <strong>is finished</strong></p>\n<ul>\n<li>\n<p>often used when child executes another program, e.g. <code class=\"language-text\">fork()</code>/<code class=\"language-text\">exec()</code>, or <code class=\"language-text\">system()</code></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">pid <span class=\"token operator\">=</span> fork<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> pid <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\nwait<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p>The parent continues to execute concurrently and independently of the child process</p>\n<ul>\n<li>\n<p>e.g. autosave feature</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">pid <span class=\"token operator\">=</span> fork<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> pid <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\ndo_something<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nexit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p>The parent continues to execute concurrently, but synchronizes with the child</p>\n<ul>\n<li>\n<p>can be complicated to synchronize</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">pid <span class=\"token operator\">=</span> fork<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> pid <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\ndo_something_1<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nsynchronize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ndo_something_2<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nsynchronize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># ...</span></code></pre></div>\n</li>\n</ul>\n</li>\n</ol>\n<h2>Process termination</h2>\n<p>Typical conditions which terminate a process:</p>\n<ul>\n<li>\n<p><strong>voluntary</strong></p>\n<ul>\n<li><em>normal exit</em> - application decides it's done, or user closes the app</li>\n<li><code class=\"language-text\">exit()</code> call</li>\n<li><em>error exit</em> - application detects an error, optionally notify the user</li>\n<li><code class=\"language-text\">exit()</code> call</li>\n</ul>\n</li>\n<li>\n<p><strong>involuntary</strong>:</p>\n<ul>\n<li><em>fatal error</em></li>\n<li>usually due to a bug in the program, detected by OS</li>\n<li>e.g. accessing invalid memory, div by zero</li>\n<li><em>involuntary</em> - killed by another process</li>\n<li>parent, or another process calls <code class=\"language-text\">kill()</code></li>\n<li>e.g. during shutdown, pressing <code class=\"language-text\">&lt;ctrl-c&gt;</code> in terminal, closing window</li>\n</ul>\n</li>\n</ul>\n<p>Parent may terminate its children for different reasons, for example:</p>\n<ul>\n<li>the child has exceeded its usage of some of the resources</li>\n<li>the task assigned to the child is no longer required</li>\n<li>the parent needs/wants to exit and wants to clean up first</li>\n</ul>\n<p>In Unix, when a parent process is terminated, the child processes may be terminated, or assigned to the grandparent process, or to the <code class=\"language-text\">init</code> process. Process hierarchy is always maintained. Default behavior on Linux is to <strong>reparent</strong> the child process to the <code class=\"language-text\">init</code> process. This can be changed (e.g. to kill children, reparent to some other process). Using <code class=\"language-text\">prctl()</code> system call, the behavior can be changed.</p>\n<p>When terminating a process, OS must free all related resources, e.g. free memory used by the process, delete PCB, delete process from process table, kill children or assign them to a new parent, close files, close open network connections.</p>\n<h2>Process scheduling</h2>\n<p>Part of multitasking is deciding which process gets the CPU next. Typical objective is to maximize CPU utilization. <strong>Process scheduler</strong> is a kernel routine/algorithm that selects an available process to execute on the CPU. Process is selected from a <em>ready queue</em>. OS maintains different scheduling queues:</p>\n<ul>\n<li>\n<p>job queue: all programs waiting to run, usually found in batch systems</p>\n<ul>\n<li>e.g. priority queue</li>\n</ul>\n</li>\n<li>\n<p>ready queue: all processes that are ready to execute their next instruction</p>\n<ul>\n<li>e.g. linked list, implemented via pointers</li>\n</ul>\n</li>\n<li>\n<p>device queue: processes waiting for a particular device</p>\n<ul>\n<li>each device has its own queue</li>\n</ul>\n</li>\n</ul>\n<h3>Process states</h3>\n<p>There are 3 process states:</p>\n<ul>\n<li><strong>running</strong> - actually running on the CPU</li>\n<li><strong>blocked</strong> - waiting for some event to occur, e.g. I/O</li>\n<li><strong>ready</strong> - the process is ready to execute on CPU</li>\n</ul>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/5796eb8a31c5e6b7b767782008a727f7/a062e/lec6-process-fsm.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 29.153605015673982%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABHElEQVQY03VRO0vDUBTOKP4b0cHN0R8ghU6Ojo76lxx0Kx0dFCwKPouEbhlsHjTJvWma3OS+Pk+uhiqlHxwOnHv4Hud66GDtT8MahkrKFmEYIQgCNI34974NXsGZW5SrAPz9FMnTAOx1CJG/uQXZNkRWOYF6cYfs+QTJ4wD84wxSpFiWFRhjJC7Jl4XXKWtibAof6eQIs/EBkvtD1OkDFLFwvkRZrqA7wniMr9s9+KN9JJNjyDpCKw0aIaCUcuXhT1hNBIpi9hOtFVgWgrMYRuv1pjXbI3c2rbuhhTEGWZa7CEpZ5C9D+Ne7mN3sgH+ekxsgCucoiuXv6e1Gebb/kL4TqTsDmajmV1hML5FOLyDikZvlWYq6rjYIe3wD183EapkJFZsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Process states\"\n        title=\"\"\n        src=\"/notes/static/5796eb8a31c5e6b7b767782008a727f7/fb8a0/lec6-process-fsm.png\"\n        srcset=\"/notes/static/5796eb8a31c5e6b7b767782008a727f7/1a291/lec6-process-fsm.png 148w,\n/notes/static/5796eb8a31c5e6b7b767782008a727f7/2bc4a/lec6-process-fsm.png 295w,\n/notes/static/5796eb8a31c5e6b7b767782008a727f7/fb8a0/lec6-process-fsm.png 590w,\n/notes/static/5796eb8a31c5e6b7b767782008a727f7/526de/lec6-process-fsm.png 885w,\n/notes/static/5796eb8a31c5e6b7b767782008a727f7/fa2eb/lec6-process-fsm.png 1180w,\n/notes/static/5796eb8a31c5e6b7b767782008a727f7/a062e/lec6-process-fsm.png 1276w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>Only 4 transitions are possible:</p>\n<ul>\n<li>ready <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding=\"application/x-tex\">\\to</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">→</span></span></span></span> running</li>\n<li>running <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding=\"application/x-tex\">\\to</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">→</span></span></span></span> ready</li>\n<li>running <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding=\"application/x-tex\">\\to</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">→</span></span></span></span> blocked</li>\n<li>blocked <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding=\"application/x-tex\">\\to</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">→</span></span></span></span> ready</li>\n</ul>\n<h3>Context switching</h3>\n<p>Context switching is essential feature of any multitasking OS. It allows illusion of sharing a single CPU (or limited number of CPUs) among many processes.</p>\n<p>OS maintains a context (state) for each process which is usually a part of PCB. When OS switches between process A and B:</p>\n<ul>\n<li>OS saves A's state in A's PCB</li>\n<li>OS restores B's state from B's PCB</li>\n</ul>\n<p>Context switching occurs in kernel mode, for example when process exceeds its <strong>time slice</strong>. Context switching also introduces time overhead, because CPU spends cycles on not useful work when restoring/saving CPU registers. Therefore, context switching is the most optimized part of the kernel</p>\n<h3>Unix signals</h3>\n<p>A form of <strong>interprocess communication</strong> (IPC):</p>\n<ul>\n<li>It's a similar concept to interrupts on CPUs. Interrupts on the application level. If application sends a signal to another application, that process is interrupted.</li>\n<li>Asynchronous</li>\n<li>Very limited IPC - messages consist of only small set of predefined integers</li>\n</ul>\n<p>A signal is used to notify a process that a particular event has occured. One process (or thread) sends a signal, another process (or thread) received it. It is possible for a process to signal itself. Signal lifetime:</p>\n<ul>\n<li>Signal is <strong>generated/sent</strong>, usually as a consequence of some event</li>\n<li>Signal is <strong>delivered/pending</strong> to a process</li>\n<li>Delivered signal is <strong>handled</strong> by the process via a <strong>signal handler</strong>.</li>\n<li>Some signals can be <strong>ignored</strong> - signal delivered to a process that ignores it, is lost</li>\n<li>Some signals can be <strong>blocked</strong> - signal stays pending until it is unblocked</li>\n</ul>\n<h4>Generating signals</h4>\n<p>Signals are generated:</p>\n<ul>\n<li>manually from process to another process</li>\n<li>periodically via timer</li>\n<li>automatically to handle exceptions</li>\n<li>from command line</li>\n</ul>\n<h4>Signal Handling</h4>\n<p><strong>Signal handler</strong> - a function that will be invoked when a signal is delivered. <strong>Default signal handler</strong> - all programs have default handlers with default behaviors. Programs can also override default handlers via <strong>user-defined handlers</strong>, except for <code class=\"language-text\">SIGKILL</code> (<code class=\"language-text\">kill -9 PID</code>), or <code class=\"language-text\">SIGSTOP &lt;ctrl-z&gt;</code>.</p>\n<p>Since signals can be delivered anytime, the state of program's data might be in an <strong>inconsistent state</strong> as well as the signal handler <em>itself</em> can be interrupted.</p>\n<hr>\n<h1>Threads</h1>\n<p>In many ways threads are similar to processes. Both can be used to write applications that need some parallelism. However, min differences are: threads are more efficient, threads are more complicated to program correctly.</p>\n<p>Informally, a thread is \"a process within a process\", or \"mini process\". A process can have multiple threads, and a thread is always associated with a process. All threads within one process share the resources of the process. A process is like a container for all its threads. All threads are scheduled independently.</p>\n<h2>Process vs Thread</h2>\n<p>Both processes and threads can be used to write concurrent applications, but there are important differences</p>\n<ul>\n<li>processes are independent and self contained</li>\n<li>threads exists as a subset of process</li>\n<li>threads belonging to the same process share many/most resources with each other</li>\n<li>processes interact only through OS mechanisms (IPC = interprocess communication)</li>\n<li>threads have more options for communication</li>\n<li>processes have easier access to built-in OS mechanisms, but they are usually less efficient than threads</li>\n</ul>\n<p><strong>Per-process items</strong>:</p>\n<ul>\n<li>address space</li>\n<li>global variables</li>\n<li>heap</li>\n<li>open files</li>\n<li>child processes</li>\n<li>signals</li>\n</ul>\n<p><strong>Per-thread items</strong>:</p>\n<ul>\n<li>registers</li>\n<li>PC</li>\n<li>stack</li>\n<li>state</li>\n</ul>\n<h2>Common thread scenarios</h2>\n<ul>\n<li>\n<p><strong>pipeline</strong></p>\n<ul>\n<li>a task is broken into a series of stages</li>\n<li>each stage handled by a different thread</li>\n</ul>\n</li>\n<li>\n<p><strong>manager/worker</strong></p>\n<ul>\n<li>one manager thread assigns work to worker threads</li>\n<li>manager thread handles all I/O</li>\n<li>worker threads can be static or dynamic</li>\n</ul>\n</li>\n<li>\n<p><strong>peer</strong></p>\n<ul>\n<li>all threads work on the same or different tasks in parallel</li>\n</ul>\n</li>\n</ul>\n<h3>Why Threads?</h3>\n<ul>\n<li>multithreaded applications can run faster on computers with multiple cores/CPUs</li>\n<li>multiple threads can parallelize access to hardware e.g. 2 threads reading different files</li>\n</ul>\n<h3>Thread pool</h3>\n<p><strong>Thread pool</strong> is a software design pattern. Program creates and maintained a pool of worker threads. Pool size can be tuned, e.g. to the available computing resources. When program needs a thread, it takes one out of the pool.</p>\n<p>Thread queues are often combined with a <strong>task queue</strong>. Instead of asking for a thread, a 'task' is inserted into a task queue. Available threads in the thread pool take tasks from the task queue and finish them.</p>\n<h3>Thread libraries</h3>\n<ul>\n<li>POSIX threads</li>\n<li>Win32</li>\n<li>Java</li>\n</ul>\n<h4>POSIX threads (aka pthreads)</h4>\n<p>To use POSIX threads:</p>\n<ul>\n<li><code class=\"language-text\">#include &lt;pthread.h&gt;</code></li>\n<li>compile with <code class=\"language-text\">gcc -lpthread</code></li>\n</ul>\n<p>pthread functions:</p>\n<ul>\n<li><code class=\"language-text\">pthread_create(thread, attr, start_routine, arg)</code> starts a thread, similar to <code class=\"language-text\">fork()</code></li>\n<li><code class=\"language-text\">pthread_exit(status)</code> terminates the current thread, similar to <code class=\"language-text\">exit()</code> or you can return from <code class=\"language-text\">start_routine</code></li>\n<li><code class=\"language-text\">pthread_join(thread, *status)</code> blocks the main, calling, thread until the specified thread terminates, similar to <code class=\"language-text\">wait()</code></li>\n<li>\n<p><code class=\"language-text\">pthread_attr_init(attr)</code> and <code class=\"language-text\">pthread_attr_destroy(attr)</code></p>\n<ul>\n<li>initializes/destroys thread attributes</li>\n<li>these can be tuned with <code class=\"language-text\">pthread_attr_set*()</code> functions</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h1>Concurrent Programming</h1>\n<h2>Threads and <code class=\"language-text\">fork()</code></h2>\n<p>When <code class=\"language-text\">fork()</code> is called in a program with multiple threads. What happens is only the calling thread survives, other threads are not duplicated. This creates a problem if synchronization mechanisms used. It's possible to register a callback in case <code class=\"language-text\">fork()</code> is called using <code class=\"language-text\">pthread_atfork()</code>. However, generally <strong><code class=\"language-text\">fork()</code> should be avoided</strong> in programs with multiple threads.</p>\n<p>Some usages are sage: e.g.:</p>\n<ul>\n<li><code class=\"language-text\">fork()</code> is immediately followed by <code class=\"language-text\">execve()</code> to execute external program</li>\n<li><code class=\"language-text\">fork()</code> is executed before creating any threads</li>\n</ul>\n<h2>Thread cancellation</h2>\n<p>Imagine a scenario when threads are used to parallelize database search. Multiple threads are searching different parts of the database. If one thread finds the result, how do we notify the other threads to stop searching?</p>\n<p>There are two general approaches:</p>\n<ul>\n<li>Asynchronous cancellation</li>\n<li>Deferred cancellation (aka synchronous cancellation)</li>\n</ul>\n<h3>Async cancellation</h3>\n<p>It's called async because there is no sync with thread that needs to be cancelled, as soon as the signal is received (so data might be missing)</p>\n<p>One thread manually terminates the target thread using <code class=\"language-text\">pthread_kill(thread_id, SIGUSR1)</code> and then target is killed instantly.</p>\n<p>Common problem is what happens to the data currently updated by the thread that is killed?</p>\n<ul>\n<li>Killed thread has no chance to clean up</li>\n<li>This can likely lead to leaving data in undefined state</li>\n</ul>\n<p>Usually, it is better to use synchronous thread cancellation.</p>\n<h3>Deferred / Synchronous Thread Cancellation</h3>\n<p>Controlling thread <strong>indicates</strong> it wishes to cancel a thread. Can be done via some global flag or <code class=\"language-text\">pthread_cancel()</code>. Target thread periodically checks whether it should terminate, checking done only at <strong>cancellation points</strong> at which a thread can be cancelled safely.</p>\n<p>Issues:</p>\n<ul>\n<li>Less performance</li>\n<li>Target thread will not react immediately</li>\n</ul>\n<h2>Race Conditions</h2>\n<p>Race condition is a behavior where the output is dependent on the sequence of timing or other uncontrollable events (e.g. context switching, scheduling on multiple CPUs). Often a result of multiple processes/threads operating on a shared state/resource, e.g.:</p>\n<ul>\n<li>modifying shared memory</li>\n<li>reading/writing to files</li>\n<li>modifying filesystems</li>\n<li>reading/writing to databases</li>\n</ul>\n<p>Let's take the following code for example</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Global variable counter</span>\n<span class=\"token keyword\">int</span> counter<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">incr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// This function is assumes that this is atomic (not interfered by anyone else)</span>\n  <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> counter<span class=\"token punctuation\">;</span>\n  x<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  counter <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> incr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> incr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pthread_join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\\n\"</span><span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>One possible <strong>execution sequence</strong>, leading to <code class=\"language-text\">counter = 2</code></p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"><strong>Thread 1</strong></th>\n<th align=\"center\"><strong>Thread 2</strong></th>\n<th align=\"center\"><strong><code class=\"language-text\">counter</code></strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">x = counter;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">x++;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">counter = x;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">x = counter;</code></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">x++;</code></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">counter = x;</code></td>\n<td align=\"center\"><code class=\"language-text\">2</code></td>\n</tr>\n</tbody>\n</table>\n<p>Another possible execution sequence leading to <code class=\"language-text\">counter = 1</code></p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"><strong>Thread 1</strong></th>\n<th align=\"center\"><strong>Thread 2</strong></th>\n<th align=\"center\"><strong><code class=\"language-text\">counter</code></strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">x = counter;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">x = counter;</code></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">x++;</code></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">counter = x;</code></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">x++;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">counter = x;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n</tbody>\n</table>\n<p>Debugging race conditions is hard, in some rare situations the output might be different, e.g. when system was less/more busy.</p>\n<h3>Avoiding Race Conditions</h3>\n<p>We need to prevent more than one process/thread from accessing the shared resource at any given time. One approach is:</p>\n<ul>\n<li>identify <strong>critical sections</strong> in code where this could happen</li>\n<li>enforce <strong>mutual exclusion</strong> to make sure it does not happen</li>\n</ul>\n<h4>Critical Sections and Mutual Exclusion</h4>\n<p><mark>Critical section/critical region</mark> is a part of the program that accesses the shared resource in a way that could lead to races or other undefined/unpredictable/unwanted behavior:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> counter<span class=\"token punctuation\">;</span> <span class=\"token comment\">// shared resource</span>\n\n<span class=\"token comment\">/**\n * Critical section\n */</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">incr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> counter<span class=\"token punctuation\">;</span>\n  x<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  counter <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If we can arrange tasks such that no two processes or threads will ever be in their critical sections at the same time, we could avoid the race condition, therefore achieving <mark>mutual exclusion</mark>.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/50265a3714c3e5a9886f001256433e03/50784/lec8-critical-sections-mutual-exclusion.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 50.54794520547945%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABQElEQVQoz4VSCW6DMBDk/18EKYEKGsA24TCXga1nEqeoStSVVoY9Z8aOjuOQvw5b11XmeaZP0yTbtjHunGNsWRaej/hvXyRvbN93ae936bqObkzDGKwxhv93n1e14uBgGBphe9u2TFhrieYry6QovkUpLXVd06uqkizNpPcLiHocWTv6c+h7xogQ1IACVAAfSLhdKbndbqK1Zh4x49EFagCAgS+pngzeUsaSJwk/rJXL5epRKi4jUs9gGAb+F0UhV59fV/d5YNAFNLRWksSJNE0jvadmtCFaDIRUiOHfucelRdCtLEuxXgvoYQfLZsRBGd/hRuM49mgvkue5JElCdMih76UhYEM/nMFRAD1RBMHTNOXFIA45UA/9MAz1Qft/NcSJwvPbDIYhGHw2PptPDzu8x4delrfeec1C43nIue8HW80KzcPk0a4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Critical Sections and Mutual Exclusion\"\n        title=\"\"\n        src=\"/notes/static/50265a3714c3e5a9886f001256433e03/fb8a0/lec8-critical-sections-mutual-exclusion.png\"\n        srcset=\"/notes/static/50265a3714c3e5a9886f001256433e03/1a291/lec8-critical-sections-mutual-exclusion.png 148w,\n/notes/static/50265a3714c3e5a9886f001256433e03/2bc4a/lec8-critical-sections-mutual-exclusion.png 295w,\n/notes/static/50265a3714c3e5a9886f001256433e03/fb8a0/lec8-critical-sections-mutual-exclusion.png 590w,\n/notes/static/50265a3714c3e5a9886f001256433e03/526de/lec8-critical-sections-mutual-exclusion.png 885w,\n/notes/static/50265a3714c3e5a9886f001256433e03/fa2eb/lec8-critical-sections-mutual-exclusion.png 1180w,\n/notes/static/50265a3714c3e5a9886f001256433e03/50784/lec8-critical-sections-mutual-exclusion.png 1460w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<hr>\n<p>Requirements to avoid race conditions:</p>\n<ul>\n<li>No two processes may be simultaneously inside their critical sections</li>\n<li>No assumptions may be made about the speeds or the number of CPUs</li>\n<li>No process running outside its critical region may block other processes</li>\n<li>\n<p>No process should have to wait forever to enter its critical section</p>\n<ul>\n<li>a process should not remain in a critical section forever</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h1>Mutexes, Locks, 'Dining Philosophers' problem</h1>\n<h2>'Dining Philosophers' Problem</h2>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/e245f682dd85636724ea918eae956471/efba4/lec9-dining-philosophers.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 105.3968253968254%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAABYlAAAWJQFJUiTwAAAD70lEQVQ4y5WU+0/TVxjG+zfshy3+ssEPJEtMDNvYiIHh5uzEKLWAuHJzDY6bXDJLi8SUwmADZ3SgDKjcAuU+IiCGNWwDFpBxlzKlOJCJDBSIjMvsHNDyWVtoFSpL9ibne3Le73mf87znPO8r4CW2sbFhHRYzGAxotVru3bvn8O9lJtjth9FotM79/f14enpSXl5uXZtMpv8PaAmwBFpsfHwcV1dXK0vbQf/FUrAzDdtsNK5vMhwYRJWahm747pZ/zWHvi/ECCxOTyWgd9g0m43O2689Ymptk4fHv27PYysCWjY25Q8o2sKX5Kfobz3NN6c3Z+ATOxUfRnOPPnXY16+vGrfs0OqY8NTVBSMCH5H97we58ONKORvk2NUmvESzyoLA0A1VGGinSvdxMeQVt3kmW/5yzg2o0GkpKSjYZJsnDCD28B6HHHn4bH+Pp3Ci1qn00Zb5FXsI+VNHHEEtiiY46Q3XaB5Qq3ahXvU63JsQKeKOpCRcXF7y8vOjs7EQQHHiMvW++wTuur9Lb00pNThKxn4XypSwI7eX36cg7SGW6iKZLR7mtEaNReZEpD+F8hA8zI60UFpfi7OyEj4/IKi1BQYEagUCAm/u7PNB3c0LsR21DFnEKpTn4EHdr/BiuFDNU4cv965+QEvkxX2QqSbuQQu7FdHq7O3Bycsbd3Z2urq7NR/m+uYmJyRmejLdyJtCb4DAZsrhoWq6KGTSz6i/zZ7AikJFKEdkKMQGhccQnyMhNCWPdMMdPbT+bC6DPUdgTA420XPYiPUpIXaaIoXI/bl07yq/ffYquKogBTSCj18MoTA0l++wR+sz3aFia21YQAstnfW3V6nh8v5fGjP1UpHrQmiNkoPS4Od0TVnbD1cGMVAVwu8yXG5eEdOYf4U6jnH/+NmAyY2zToU3Qz56u0KYO4Mfsg6TLpCTERFJ/0Rd9XRDDVRJylSHIYqLIkov4IesjRtty7dq1V8pm2TwX9LSuDqXUjc/PySitzSdGKqGvSEh1ujdBp6TUNxcSHnaaW+rjLD/5YytV03ZAWxexWUv1FbwP+3M6Op5vEk+iSd5PfcYBJAGnkEbEkhgp4ZG+3QHM/ig2ML1eT3Kyiubmm3S1NJCTKEb7tRsNX71H+xVP6tIOcFUVzdjwLywu/8XMzLQ9dhtDm1OhUBARHo5EYmYwO2v2rDE91sPEYCOTwy0sPtJvquHBQyrMIi4rK2NhYcER0LaQyxVERkbi6+uLTqfbtYn29vRQXFxMQUEBs9aDd2HY0dGBUCg0A8tZXV21F7+1tW3NFrOwUqvVFBUV2Tu7HfDFhcWGhoZYXFx0eKidTXV+fp6VlRV2xv8LMhBwjOSZc78AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Philosophers\"\n        title=\"\"\n        src=\"/notes/static/e245f682dd85636724ea918eae956471/fb8a0/lec9-dining-philosophers.png\"\n        srcset=\"/notes/static/e245f682dd85636724ea918eae956471/1a291/lec9-dining-philosophers.png 148w,\n/notes/static/e245f682dd85636724ea918eae956471/2bc4a/lec9-dining-philosophers.png 295w,\n/notes/static/e245f682dd85636724ea918eae956471/fb8a0/lec9-dining-philosophers.png 590w,\n/notes/static/e245f682dd85636724ea918eae956471/efba4/lec9-dining-philosophers.png 630w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>There are 5 philosophers sitting around a table. Philosophers want to do 2 things, forever:</p>\n<ul>\n<li>eat, and then</li>\n<li>think</li>\n</ul>\n<p>There are 5 bowls of food, one for each philosophers &#x26; 5 forks placed between bowls. Before eating, a philosopher must grab two forks, immediately to the left &#x26; right. Philosopher then eats for a short time. When done eating, the philosopher puts down the forks in their original positions. Philosopher then thinks for a short time.</p>\n<p><strong>Software scenario</strong>:</p>\n<ul>\n<li>5 processes/threads, each needs exclusive access to two resources to proceed.</li>\n</ul>\n<p>How to allocate resources so that all processes/threads get to execute? What is the <strong>best</strong> algorithm for threads/processes to follow?</p>\n<p>Assuming each philosopher eats &#x26; thinks for the exact same amount of time, optimal schedule:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">repeat:\n  1 &amp; 3 eat\n  2 &amp; 4 eat\n  3 &amp; 5 eat\n  4 &amp; 1 eat\n  5 &amp; 2 eat</code></pre></div>\n<blockquote>\n<p>There is no solution for every case.</p>\n</blockquote>\n<hr>\n<p><strong>Attempt 1</strong>:</p>\n<p>Assuming that philosophers are \"perfectly synchronized\". Each philosopher follows these steps:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">repeat forever:\n  grab left fork\n  grab right fork\n  eat\n  put forks back\n  think</code></pre></div>\n<p>This would lead to a <mark><strong>deadlock</strong></mark>:</p>\n<ul>\n<li>assuming all philosophers are reasonably synchronized</li>\n<li>each philosopher will end up grabbing the left fork</li>\n<li>each philosopher will be stuck trying to grab the right fork</li>\n<li>nobody gets to eat at all</li>\n</ul>\n<p><strong>Attempt 2</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">repeat forever:\n  repeat:\n    try to grab left fork\n    try to grab right fork\n    if both forks grabbed:\n      break\n    else:\n      put any grabbed forks back and take a short nap\n  eat\n  put forks back\n  think</code></pre></div>\n<p>This would reach <mark><strong>livelock</strong></mark>:</p>\n<ul>\n<li>assuming they are all synchronized</li>\n<li>all philosophers will indefinitely switch switch between napping and attempting to eat</li>\n<li>nobody will eat - form of <strong>starvation</strong></li>\n</ul>\n<p><strong>Attempt 3</strong>:</p>\n<p>Same as before, but there is one pink hat that one philosopher is wearing</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">repeat forever:\n  wait for hat\n  grab forks, eat, put forks back\n  give hat to someone else\n  think</code></pre></div>\n<p>It would work, but:</p>\n<ul>\n<li>only one process get to eat</li>\n<li>but with 5 forks, 2 philosophers could be eating at the same time</li>\n<li>it defeats the purpose of multithreading (no parallelism of eating); not optimal use of resources</li>\n<li>called arbitrator solution</li>\n</ul>\n<p><strong>Attempt 4</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">while true:\n  repeat\n    try to grab left fork\n    try to grab right fork\n    if both forks grabbed:\n      break\n    else:\n      put any grabbed forks back\n      take a short **RANDOM** nap\n  eat\n  put forks back\n  think</code></pre></div>\n<p>We introduce a random <strong>timeout</strong> mechanism for preventing deadlocks. Likely to work, often used in real world, for example in networking. However, there is still a small chance for starvation:</p>\n<ul>\n<li>if sleep is the same for all philosophers, then no one gets to eat</li>\n<li>in some cases some philosophers might never get to eat, or some philosophers will get to eat less often than the others - <em>fairness problem</em></li>\n</ul>\n<p><strong>Attempt 5</strong>:</p>\n<ul>\n<li>Label the forks with numbers: 1, ..., 5</li>\n<li>\n<p>Each philosopher:</p>\n<ul>\n<li>picks up the fork with the smallest number first, then the larger number second</li>\n<li>if unable to pick up both forks, put a claimed fork down and take a short nap</li>\n</ul>\n</li>\n</ul>\n<p>This is a <strong>resource hierarchy</strong> solution - by establishing a <strong>partial order</strong> on resources. Starvation is still possible. Also not always practical for large/dynamic number of resources.</p>\n<hr>\n<p><strong>Naive algorithm implementation</strong>:</p>\n<p>Even trying to implement a naive solution presents problems. Consider algorithm for #1:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">/* \n  Utencil state: \n    true = available\n    false = unavailable\n*/</span>\nbool forks<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                          <span class=\"token comment\">// think for s seconds</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>forks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> forks<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// i + 1 % 5 arithmetic</span>\n  forks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n  forks<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                          <span class=\"token comment\">// eat for m seconds</span>\n  forks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span>\n  forks<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Depending on the execution order (e.g. multicore machines, or timing of context switches):</p>\n<ul>\n<li>both philosophers could start eating at the same time</li>\n<li>i.e. both processes could enter the critical region</li>\n</ul>\n<p>In that code, the shared resource is the global variable <code class=\"language-text\">forks[]</code>. The critical sections are:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">/* \n  Utencil state: \n    true = available\n    false = unavailable\n*/</span>\nbool forks<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>forks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> forks<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// critical section</span></span><span class=\"gatsby-highlight-code-line\">  forks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  forks<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></span>  <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                          <span class=\"token comment\">// critical section</span>\n<span class=\"gatsby-highlight-code-line\">  forks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  forks<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h2>Mutex (aka Lock)</h2>\n<p><strong>Mutex</strong> is a synchronization mechanism used for ensuring <strong>exclusive access</strong> to a resource in concurrent programs. Think of mutex as a special boolean type that can represent a lock:</p>\n<ul>\n<li><code class=\"language-text\">true</code> <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding=\"application/x-tex\">\\to</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">→</span></span></span></span> locked</li>\n<li><code class=\"language-text\">false</code> <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding=\"application/x-tex\">\\to</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">→</span></span></span></span> unlocked</li>\n</ul>\n<p>We can set it to <code class=\"language-text\">true</code> or <code class=\"language-text\">false</code> just like a regular boolean variable. But, if the lock is already locked, and some thread tries to also lock it, then the calling thread will be automatically suspended until whoever locked the lock, unlocks it.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">mutex lock<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Will block if already TRUE</span>\nlock <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/*\n Critical section\n\n it is protected by the mutex lock\n*/</span>\n\n<span class=\"token comment\">// May unblock some other thread</span>\nlock <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Mutex is often implemented as an object with two possible states: <em>locked</em> and <em>unlocked</em>. It implements two operations <code class=\"language-text\">lock()</code> and <code class=\"language-text\">unlock()</code>. If multiple threads call <code class=\"language-text\">lock()</code> simultaneously, only one will proceed, the others will block. Therefore, only the thread <em>that locks</em> the mutes can <em>unlock it</em>.</p>\n<p>A waiting queue is used to keep track of all threads waiting on the mutex to be unlocked. Once the mutex is unlocked, one of the blocked threads will be unlocked. <em>Note</em>: which one thread gets unlocked is usually not predictable. It can be implemented in software via busy waiting, but usually supported by hardware + OS. Portable libraries often try to use H/W mutex but are able to fall back to software.</p>\n<h3>Mutex in pthread</h3>\n<table>\n<thead>\n<tr>\n<th>API</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">pthread_mutex_init()</code></td>\n<td>create a mutex</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">pthread_mutex_destroy()</code></td>\n<td>destroy a mutex</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">pthread_mutex_lock()</code></td>\n<td>lock a mutex, block if already locked</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">pthread_mutex_trylock()</code></td>\n<td>lock a mutex, or fail (non-blocking version)</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">pthread_mutex_unlock()</code></td>\n<td>unlock a mutex</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Counter with mutex</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span>\n\n<span class=\"token comment\">// initialized in main() with pthread_mutex_init()</span>\npthread_mutex_t count_mutex<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// initialized in main() with counter = 0</span>\n<span class=\"token keyword\">int</span> counter<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">incr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// acquire the lock</span>\n  <span class=\"token function\">pthread_mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>count_mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> counter<span class=\"token punctuation\">;</span>\n  x<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  counter <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// release the lock</span>\n  <span class=\"token function\">pthread_mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>count_mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Dining philosopher with mutex</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre style=\"counter-reset: linenumber 0\" class=\"language-c line-numbers\"><code class=\"language-c\">pthread_mutex_t mutex<span class=\"token punctuation\">;</span>\nbool forks<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">pthread_mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>forks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> forks<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  forks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  forks<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">pthread_mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n  <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">pthread_mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  forks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  forks<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">pthread_mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>However, this will not work, due to <strong>deadlock</strong>. <code class=\"language-text\">while (!forks[i] || forks[i + 1]);</code> will result in an infinite loop. It can also be argued that this is a <strong>livelock</strong>.</p>\n<hr>\n<h2>Summary</h2>\n<ul>\n<li><strong>Critical section</strong> - part of the program where a shared resource is accessed &#x26; may cause trouble</li>\n<li><strong>Mutual exclusion</strong> - ensuring only one process accesses a resource at a time, e.g. only one process can enter critical section at a time</li>\n<li><strong>Mutex/lock</strong> - mechanism to achieve mutual exclusion, two states + queue</li>\n<li><strong>Deadlock</strong> - a state where each process/thread is waiting on another to release a lock <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding=\"application/x-tex\">\\to</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">→</span></span></span></span> no progress is made</li>\n<li><strong>Livelock</strong> - states of the process change, but none are progressing</li>\n<li><strong>Starvation</strong> - one process does not get to run at all</li>\n<li><strong>Unfairness</strong> - not all processes get equal opportunity to progress</li>\n<li>\n<p>There are some thread issues:</p>\n<ul>\n<li><code class=\"language-text\">fork()</code>, cancellation, signals, thread pool</li>\n<li>race conditions</li>\n<li>critical section, mutual exclusion</li>\n<li>dining philosophers problem</li>\n<li>mutex</li>\n<li>deadlock, livelock, starvation, fairness</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h1>Synchronization Mechanisms. Condition Variables, Semaphores and Other Synchronization Mechanisms</h1>\n<p>TODO: lec11</p>\n<h2>Condition Variables</h2>\n<p>Condition variables are another type of synchronization primitives. They're used together with mutexes. CVs are perfect for implementing critical sections containing loops waiting for some condition.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">mutex <span class=\"token operator\">&amp;</span>m<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Critical section is protected with mutex `m`</span>\n<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>condition<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The condition can only become true, if <strong>another thread runs it's critical section</strong>. A common pattern of using CVs:</p>\n<ul>\n<li>a thread enters it's critical section (locks a mutex)</li>\n<li>inside critical sections, thread needs to wait for some condition to become true</li>\n<li>but the condition can only become true by allowing some other thread to lock the mutex</li>\n<li>the thread has to wait and release the mutex</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">mutex <span class=\"token operator\">&amp;</span>m<span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>condition<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span>cv<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now, some other thread can lock the mutex and execute code that will satisfy the condition. Eventually, the other thread:</p>\n<ul>\n<li>locks the mutex (optional)</li>\n<li>changes some state that will satisfy the condition</li>\n<li>notifies the waiting thread via condition variable</li>\n<li>releases the mutex (optional)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">mutex <span class=\"token operator\">&amp;</span>m<span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  condition <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">signal</span><span class=\"token punctuation\">(</span>cv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>POSIX provides with <code class=\"language-text\">pthread_cond_t</code> condition variable with following functions:</p>\n<ul>\n<li><code class=\"language-text\">pthread_cond_wait(&amp;cond, &amp;mutex);</code>. Atomically releases mutex and causes the calling thread to block, until some other thread calls <code class=\"language-text\">pthread_cond_signal(&amp;cond)</code>. After returning, the mutex is automatically re-acquired, the condition is also must be checked due to <em>spurious wakeups</em>.</li>\n<li><code class=\"language-text\">pthread_cond_signal(&amp;cond);</code>. Wakes (signals) up thread waiting on <code class=\"language-text\">cond</code>. If no threads waiting on condition, the signal is lost. Must be followed by <code class=\"language-text\">pthread_mutex_unlock()</code> <strong>if the blocked thread uses the same mutex</strong>.</li>\n</ul>\n<p><strong>Example</strong>:</p>\n<p>Thread 1 decrementing counter, but never below 0, thread 2 incrementing counter. This doesn't have deadlocks and no busy waiting.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Thread 1</span>\n\n<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">pthread_mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>count <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">pthread_cond_wait</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>cond<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  count<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">pthread_mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Thread 2</span>\n\n<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">pthread_mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  counter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token function\">pthread_cond_signal</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>cond<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pthread_mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Semaphore</h2>\n<p>Semaphore is another synchronization primitive. A special integer variable used for signalling. The value could indicate number of available units of some resource. Semaphore supports three operations:</p>\n<ul>\n<li><strong>Initialization</strong>: can be initialized with any value 0 ... <code class=\"language-text\">INT_MAX</code></li>\n<li><strong>Decrement</strong>: reduces semaphore value by 1, blocks the calling process if &#x3C; 0; <code class=\"language-text\">down(s)</code> or <code class=\"language-text\">wait(s)</code>.</li>\n<li><strong>Increment</strong>: increases value by 1 and possibly unblocks another blocked prosess; <code class=\"language-text\">up(s)</code> or <code class=\"language-text\">signal(s)</code>.</li>\n</ul>\n<p>Semaphore can be used to protect critical sections, similar to a mutex:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">semaphore s<span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">wait</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Critical section ...</span>\n<span class=\"token function\">signal</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Each semaphore maintains a queue of processes blocked on the semaphore. When a semaphore is locked by a thread, it can be unlocked by <strong>any thread</strong>, as opposed to a mutex, where locking/unlocking must be done by the same thread. That makes semaphores more suitable for producer-consumer problems.</p>\n<h3>Binary semaphore</h3>\n<p>It is a special type of semaphore, with value <code class=\"language-text\">[0, 1]</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  s <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  s <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Where the bodies are executed <strong>atomically</strong>. An <strong>atomic operation</strong> is an operation that <em>appears to execute instanteneously</em>, with respect to the rest of the system, e.g. it cannot be interrupted by signals, threads, interrupts.</p>\n<h3>Counting semaphore</h3>\n<p>A <strong>general semaphore</strong>, represents an integer value <code class=\"language-text\">S</code>, where:</p>\n<ul>\n<li><code class=\"language-s \"> 0</code>: value of <code class=\"language-text\">S</code> is the number of processes/threads that can issue a wait and immediately continue to execute.</li>\n<li><code class=\"language-text\">S = 0</code>: all resources are busy, the calling thread/process must wait</li>\n<li><code class=\"language-text\">S &lt; 0</code>: (not all implementations do this), <code class=\"language-text\">abs(S)</code> represents the number of processes/threads that are waiting to be unblocked.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  s<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  s<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Where the functions are executed <strong>atomically</strong>.</p>\n<h2>Semaphores vs. Condition Variables</h2>\n<ul>\n<li>\n<p><code class=\"language-text\">signal()</code> compared to <code class=\"language-text\">cv_signal()</code>:</p>\n<ul>\n<li><code class=\"language-text\">cv_signal()</code> is lost, if no thread is waiting.</li>\n<li><code class=\"language-text\">signal()</code> increments the semaphore always, and possibly wakes up a thread.</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">wait()</code> compared to <code class=\"language-text\">cv_wait</code>:</p>\n<ul>\n<li><code class=\"language-text\">cv_wait()</code> does not check the condition, always blocks.</li>\n<li><code class=\"language-text\">wait()</code> checks the value of the semaphore and may or may no block.</li>\n</ul>\n</li>\n</ul>\n<hr>\n<p><strong>Possible errors</strong></p>\n<p>You need to be careful with order in which <code class=\"language-text\">signal</code> and <code class=\"language-text\">wait</code> are called.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">/*\n * The following will violate mutual exclusivity\n */</span>\n<span class=\"token function\">signal</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Critical section ...</span>\n<span class=\"token function\">wait</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/*\n * This will lead to deadlock\n */</span>\n<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Critical section ...</span>\n<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Monitors</h2>\n<p>A <strong>monitor</strong> is a high level construct compared to mutexes and semaphores. A monitor is a <strong>programming language construct</strong> that controls access to shared data. Synchronization code automatically added by a compiler, then enforced at runtime. e.g. in Java, implemented using <code class=\"language-text\">synchronized() {...}</code>.</p>\n<p>A monitor is a module that encapsulates:</p>\n<ul>\n<li>Shared data structure</li>\n<li>Methods that operate on these shared data structures</li>\n<li>Synchronization is done between concurrent method invocations</li>\n</ul>\n<p>Data in monitors can only be accessed via the published methods. A properly implemented monitor is virtually impossible to use in a wrong way.</p>\n<p>Another way to look at a monitor is:</p>\n<ul>\n<li>a thread safe class/object</li>\n<li>automatic mutual exclusion on every method (via built-in mutex)</li>\n<li>can include condition variables for signalling conditions</li>\n</ul>\n<p>Monitors implement automatic mutual exclusion. Only one thread can execute any monitor method at any time (per instance), all other threads would block if they tried. Monitors maintain their own queues.</p>\n<p><strong>Example</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">/**\n * Calling  incr() or decr() from multiple threads would allow one thread in, the rest will be blocked.\n * Think of it this way: All bodies of all methods are critical sections, protected by one mutex.\n */</span>\nMonitor counter <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">void</span> <span class=\"token function\">incr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> c <span class=\"token operator\">+</span><span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">decr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> c <span class=\"token operator\">-</span><span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Monitors with condition variables</h3>\n<p>Monitors can have their own condition variables. CVs declared as part of the module, only accessible from within the module (are private). Similar functionality to <code class=\"language-text\">pthread_cond_t</code>.</p>\n<h3>Monitors vs. semaphores &#x26; mutexes</h3>\n<p>Once a monitor is correctly implemented, access to the protected resource is correct for accessing from all threads. With semaphores or mutexes, resourece access is correct only if <strong>all threads that access the resource are programmed correctly</strong>.</p>\n<h2>Spinlocks</h2>\n<p>Spinlock is another synchronization mechanism. It's a lightweight alternative to mutex, implemented using busy waiting loops. Usually implemented in assembly, using <strong>atomic operations</strong>. It's very efficient if you know that wait time will be very short, because no re-scheduling required (only makes sense on multicore CPUs).</p>\n<blockquote>\n<p>Atomic operation - an operation that appears to execute instantaneously with respect to the rest of the system, i.e. it cannot be <em>interrupted</em> by anything else</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">spinlock s<span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">spin_lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">/* short critical section */</span>\n<span class=\"token function\">spin_unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Other synchronization mechanisms</h2>\n<p><strong>Event flags</strong></p>\n<p>A memory word with N bits. Different events may be associated with different bits in a flag. Available operations:</p>\n<ul>\n<li>Set flag</li>\n<li>Clear flag</li>\n<li>Wait for 1 flag</li>\n<li>Wait for any flag</li>\n<li>Wait for all flags</li>\n</ul>\n<p><strong>Message passing</strong></p>\n<p>Processes send each other <strong>messages</strong>. Messages can contain arbitrary data, delivered messages can be up in <strong>mailboxes</strong>. Processes can check contents of mailboxes, take messages out, or wait for messages. Common implementation is MPI (message passing interface). It's very popular in HPC (high performance computers).</p>\n<p>Processes send each other <strong>messages</strong>. Messages can contain arbitrary data. Delivered messages can be queues up in <strong>mailboxes</strong>. Process can check contents of mailboxes, take messages out, or wait for messages. Common implementation is MPI (Message passing interface).</p>\n<h2>Priority inversion</h2>\n<!-- TODO: Finish all before synch hardware -->\n<h2>Synchronization hardware</h2>\n<p>Race conditions are prevented by ensuring that critical sections are protected by locks:</p>\n<ul>\n<li>A process must acquire a lock before entering a CS</li>\n<li>A process releases the lock when it exits the CS</li>\n</ul>\n<p>Many modern systems provide special hardware instructions that implement useful atomic operations.</p>\n<h3>Compare-and-swap (CAS)</h3>\n<p>Atomic operation used for synchronization. It's supported by most CPUs, e.g. <code class=\"language-text\">cmpxchg</code> on Intel. General algorithm for compare and swap:</p>\n<ul>\n<li>Compare contents of memory to <code class=\"language-text\">val1</code></li>\n<li>If they are the same, change the memory to <code class=\"language-text\">val2</code></li>\n<li>Return the old contents of memory</li>\n</ul>\n<p>Operation must be atomic.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> cas <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>mem<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> val1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> val2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> old <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>mem<span class=\"token punctuation\">;</span>     <span class=\"token comment\">//</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>old <span class=\"token operator\">==</span> val1<span class=\"token punctuation\">)</span>    <span class=\"token comment\">// Must be atomic! Can't implement it in c</span>\n    <span class=\"token operator\">*</span>mem <span class=\"token operator\">=</span> val2<span class=\"token punctuation\">;</span>      <span class=\"token comment\">//</span>\n  <span class=\"token keyword\">return</span> old<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Usage:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> p <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">cas</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>p<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">/* wait loop */</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// Critical section</span>\n  p <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// Non-critical section</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Compare-and-swap in GCC 4.4+</strong></p>\n<p><code class=\"language-text\">gcc</code> provides a number of atomic operations, including CAS:</p>\n<ul>\n<li>\n<p><code class=\"language-text\">type __sync_val_compare_and_swap(type *ptr, type oldval, type newval)</code></p>\n<ul>\n<li>atomic compare and swap</li>\n<li>if the current value of <code class=\"language-text\">*ptr</code> is <code class=\"language-text\">oldval</code>, then write <code class=\"language-text\">newval</code> into <code class=\"language-text\">*ptr</code></li>\n<li>returns the original value of <code class=\"language-text\">*ptr</code></li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">bool __sync_bool_compare_and_swap(type *ptr, type oldval, type newval)</code></p>\n<ul>\n<li>same as above, but return <code class=\"language-text\">true</code> if <code class=\"language-text\">newval</code> was written</li>\n</ul>\n</li>\n</ul>\n<p><strong>Spinlock using compare-and-swap</strong>:</p>\n<!-- TODO: Finish -->\n<h3>Test-and-set</h3>\n<p>A specialized version of compare-and-swap. Old hardware had test-and-set, newer hardware uses more generalized compare-and-swap. General algorithm:</p>\n<ul>\n<li>remember contents of memory</li>\n<li>set memory to true</li>\n<li>return the old contents of memory</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">tas</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>mem<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> old <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>mem<span class=\"token punctuation\">;</span>  <span class=\"token comment\">//</span>\n  <span class=\"token operator\">*</span>mem <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// atomic!</span>\n  <span class=\"token keyword\">return</span> old<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Usage:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> p <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token function\">tas</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// critical section</span>\n  p <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// non-critical section</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Swap</h3>\n<p>Another atomic operation that can be used for synchronization. General algorithm:</p>\n<ul>\n<li>atomically swap contents of two memory location</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">swap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>a<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>b<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> tmr <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>a<span class=\"token punctuation\">;</span> <span class=\"token comment\">//</span>\n  <span class=\"token operator\">*</span>a <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>b<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// atomic!</span>\n  <span class=\"token operator\">*</span>b <span class=\"token operator\">=</span> tmr<span class=\"token punctuation\">;</span>     <span class=\"token comment\">//</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Usage:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> lock <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> key <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">swap</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>lock<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// critical section</span>\n  lock <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// non-critical section</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h3>Bounded waiting with synchronization hardware</h3>\n<p>When used correctly, the atomic operations, such as compare-and-swap, test-and-set, swap can be used to achieve mutual exclusion, progress and speed. But they are too low level to achieve bounded waiting, especially for more than 2 processes. Bounded waiting can be 'added', e.g. via two shared variables:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// a CS lock</span>\n<span class=\"token keyword\">int</span> lock<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// which processes want to enter CS</span>\n<span class=\"token keyword\">int</span> waiting<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Example:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// TODO</span></code></pre></div>\n<hr>\n<p>Synchronization hardware can be used to implement mutual exclusion, progress, speed and even bounded waiting.</p>\n<p>Drawbacks:</p>\n<ul>\n<li>busy-waiting (spinlocks)</li>\n<li>extra coding (e.g. to add bounded waiting)</li>\n</ul>\n<p>Advantage:</p>\n<ul>\n<li>avoid system calls</li>\n<li>can be more efficient if expected wait time is short</li>\n<li>only makes sense on multi-CPU/core systems</li>\n</ul>\n<hr>\n<h1>CPU Scheduling</h1>\n<p>TODO: lec12</p>\n<p>Recall multiprogramming:</p>\n<ul>\n<li>Objective is to maximize CPU utilization by having a process running at all time</li>\n<li>Several processes are kept in memory at one time</li>\n<li>A process runs until it must wait</li>\n<li>Instead of having CPU sit idle, the OS takes the CPU away from the waiting and gives it to another process that is ready to run</li>\n</ul>\n<p>The software that decides which process runs next is called a <strong>scheduler</strong>. Scheduler is usually a part of a kernel and it is an implementation of some <strong>scheduling algorithm</strong>.</p>\n<h2>Process behaviour</h2>\n<p>Most processes alternate bursts of CPU activity with bursts of I/O activity. <strong>CPU-bound</strong> (or compute-bound) processes - have long CPU bursts and infrequent I/O waits. <strong>I/O bound</strong> processes - have short CPU burst and frequent I/O waits.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/ffef6ead13cd6c893fc52ed5bd353222/3a2d6/lec12-bound.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 35.531135531135526%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA8klEQVQoz4VRSW6EQAzs/7+MM0ckQjMg9rUZVgE1XU5IRnMglko27XJ5QSVJAs/zEEURqqpCoDWCIECaphjHEeHjAc03i7quEccxfP9L4qZphKt1aL1GnudQ67pago8wDLEsC9q2QxzFGIYB+76L6AVyp2nC8/kdU5Dv8zyLZ73Cm53nCWMM+r63pAX/mQhZcdZdpu4KOCEn5nqc4NP4VpaV5H8Ft22TTvQEVyGub5K7rhPOlbvybHgch+QpzlhxRcdx4LouSvtTqh+Y3siN2rZFbwvoedcsy+xUpZyFYEx+URR/N6QycXcrY8XYYF3ub/sCKDIcNobD4TcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"CPU-bound vs I/O bound\"\n        title=\"\"\n        src=\"/notes/static/ffef6ead13cd6c893fc52ed5bd353222/fb8a0/lec12-bound.png\"\n        srcset=\"/notes/static/ffef6ead13cd6c893fc52ed5bd353222/1a291/lec12-bound.png 148w,\n/notes/static/ffef6ead13cd6c893fc52ed5bd353222/2bc4a/lec12-bound.png 295w,\n/notes/static/ffef6ead13cd6c893fc52ed5bd353222/fb8a0/lec12-bound.png 590w,\n/notes/static/ffef6ead13cd6c893fc52ed5bd353222/526de/lec12-bound.png 885w,\n/notes/static/ffef6ead13cd6c893fc52ed5bd353222/3a2d6/lec12-bound.png 1092w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>As CPUs get faster, processes tent to get more I/O bound. It takes quite a few I/O bound processes to keep the CPU fully occupied.</p>\n<h2>When to schedule</h2>\n<!-- TODO -->\n<h2>Preemptive vs non-preemptive CPU scheduling</h2>\n<ul>\n<li>\n<p><mark><b>Non-preemptive</b></mark> - Context switch happens only voluntarily</p>\n<ul>\n<li>Multitasking is possible, but only through cooperation</li>\n<li>Process runs until it does a blocking syscall (e.g. I/O), terminates, or voluntarily yields CPU</li>\n</ul>\n</li>\n<li>\n<p><mark><b>Preemptive</b></mark> - Context switch can happen without cooperation</p>\n<ul>\n<li>Usually as a direct or indirect result of some event, but not limited to clock interrupt, e.g. new job is added, existing process is unblocked</li>\n<li>preemptive is often (mis)used to mean preemptive time-sharing</li>\n</ul>\n</li>\n<li>\n<p><mark><b>Preemptive time-sharing</b></mark> - Special case of preemptive</p>\n<ul>\n<li>TODO</li>\n</ul>\n</li>\n</ul>\n<h2>Categories of scheduling algorithms</h2>\n<!-- TODO -->\n<h3>Scheduling metrics</h3>\n<ul>\n<li><strong>Arrival time</strong>: the time a process arrives</li>\n<li>\n<p><strong>Start time</strong>: the time process first gets to run on CPU</p>\n<ul>\n<li>different from arrival time for batch systems, identical to arrival on interactive systems</li>\n</ul>\n</li>\n<li><strong>Finish time</strong>: when the process is done (time of the last instruction)</li>\n<li><strong>Response time</strong>: how long before you get first feedback, often response = start - arrival</li>\n<li><strong>Turnaround time</strong>: time from arrival to finish, runaround = finish - arrival</li>\n<li><strong>CPU time</strong>: how much time the process spent on CPU</li>\n<li><strong>Waiting time</strong>: total time spent in waiting queue, waiting = turnaround = CPU - I/O</li>\n</ul>\n<p>Overall statistics:</p>\n<ul>\n<li><strong>average turnaround time, average wait time</strong>...</li>\n<li><strong>throughput</strong> - number of jobs finished per unit of time</li>\n</ul>\n<p><strong>Goals of scheduling algorithms</strong>:</p>\n<ul>\n<li>\n<p>All systems</p>\n<ul>\n<li><strong>fairness</strong>: giving each process a fair share of the CPU</li>\n<li><strong>policy/priority enforcement</strong>:</li>\n<li><strong>balance</strong>:</li>\n</ul>\n</li>\n<li>Batch systems</li>\n<li>Interactive systems</li>\n<li>Real systems</li>\n</ul>\n<hr>\n<h2>First-come-first-served (FCFS) scheduling</h2>\n<!-- TODO -->\n<p><strong>Gantt chart</strong>: used to visualize scheduling of 5 processes</p>\n<p>List of processes (for simplicity, assume no I/O activity):</p>\n<table>\n<thead>\n<tr>\n<th>Process</th>\n<th>Arrival</th>\n<th>Burst</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>P1</td>\n<td>0</td>\n<td>6</td>\n</tr>\n<tr>\n<td>P2</td>\n<td>0</td>\n<td>6</td>\n</tr>\n<tr>\n<td>P3</td>\n<td>1</td>\n<td>3</td>\n</tr>\n<tr>\n<td>P4</td>\n<td>2</td>\n<td>8</td>\n</tr>\n<tr>\n<td>P5</td>\n<td>3</td>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>Gantt chart:</p>\n<div class=\"gatsby-highlight\" data-language=\"mermaid-svg\"><pre class=\"language-mermaid-svg\"><code class=\"language-mermaid-svg\">gantt\n    title FCFS Scheduling\n    dateFormat  DD-MM-YYYY\n    section CPU\n    P1: p1, 6d\n    P2: p2, after p1, 6d\n    P3: p3, after p2, 3d\n    P4: p4, after p3, 8d\n    P5: p5, after p4, 2d</code></pre></div>\n<p><strong>Simulating scheduling</strong>:</p>\n<!-- TODO -->\n<p><strong>Calculating statistics</strong>:</p>\n<!-- TODO -->\n<hr>\n<h3>Convoy Effect</h3>\n<p>Big disadvantage of FCFS is the <strong>convoy effect</strong>. Scenario: one CPU-bound process + many I/O bound processes. Result: the CPU-bound process will tie up the CPU, making the I/O bound processes run for much longer.</p>\n<p><strong>Example</strong>:</p>\n<ul>\n<li>Single CPU-bound process <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding=\"application/x-tex\">A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathdefault\">A</span></span></span></span>, with 1s long CPU burst cycles</li>\n<li>Many I/O bound processes <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>B</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">B_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.05017em;\">B</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>, with each needing 1000 I/O operations, each <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mfrac><mn>1</mn><mn>1000</mn></mfrac><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">\\frac{1}{1000}s</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mord mathdefault\">s</span></span></span></span> long</li>\n</ul>\n<!-- TODO -->\n<h2>Round-robin scheduling (RR)</h2>\n<p><strong>Round robin</strong> scheduler is a preemptive version of the FCFS scheduler, where each process is assigned a time interval, called a <strong>time slice</strong> or a <strong>quantum</strong>. If the process exceeds the quantum, the process is preempted (context switch), and CPU is given to the next process in ready queue. Preempted process goes at the back of the ready queue.</p>\n<p><strong>Gantt chart</strong>:</p>\n<p>Using a quantum = 3msec</p>\n<table>\n<thead>\n<tr>\n<th>Process</th>\n<th>Arrival</th>\n<th>Burst</th>\n<th>Start</th>\n<th>Finish</th>\n<th>Turnaround</th>\n<th>Waiting</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>P1</td>\n<td>0</td>\n<td>6</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>P2</td>\n<td>0</td>\n<td>6</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>P3</td>\n<td>1</td>\n<td>3</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>P4</td>\n<td>2</td>\n<td>8</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>P5</td>\n<td>3</td>\n<td>2</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<!-- TODO -->\n<div class=\"gatsby-highlight\" data-language=\"mermaid-svg\"><pre class=\"language-mermaid-svg\"><code class=\"language-mermaid-svg\"></code></pre></div>\n<p>(Context switches happen when number changes)</p>\n<p><strong>Time Slice</strong></p>\n<p>Performance of RR depends on the size of the time quantum <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=\"application/x-tex\">Q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\">Q</span></span></span></span> and the time required for a context switch <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.05764em;\">S</span></span></span></span>. For example, if <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>S</mi><mo>=</mo><mn>1</mn><mi>m</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">S = 1ms</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.05764em;\">S</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord mathdefault\">m</span><span class=\"mord mathdefault\">s</span></span></span></span>, <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>Q</mi><mo>=</mo><mn>4</mn><mi>m</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">Q = 4ms</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\">Q</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">4</span><span class=\"mord mathdefault\">m</span><span class=\"mord mathdefault\">s</span></span></span></span>, then CPU will spend <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mn>1</mn><mi mathvariant=\"normal\">/</mi><mo>(</mo><mn>4</mn><mo>+</mo><mn>1</mn><mo>)</mo><mo>=</mo><mn>20</mn><mi mathvariant=\"normal\">%</mi></mrow><annotation encoding=\"application/x-tex\">1/(4 + 1) = 20\\%</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mord\">/</span><span class=\"mopen\">(</span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">2</span><span class=\"mord\">0</span><span class=\"mord\">%</span></span></span></span> of its time on useless tasks. Very small <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=\"application/x-tex\">Q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\">Q</span></span></span></span> implies heavy overhead, but highly responsive system. Very large <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=\"application/x-tex\">Q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\">Q</span></span></span></span> implies minimum overhead, but a non-responsive system. So <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>Q</mi></mrow><annotation encoding=\"application/x-tex\">Q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\">Q</span></span></span></span> should be large compared to <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.05764em;\">S</span></span></span></span>, but not too large:</p>\n<ul>\n<li>Good rule of thumb is that 80% of the CPU bursts should be shorter than the time quantum.</li>\n<li>Quantum of around 20-100ms is often a reasonable compromise.</li>\n</ul>\n<h2>Shortest-job-first scheduling (SJF)</h2>\n<p><strong>Shortest-job-first scheduler</strong> is non-preemptive scheduling algorithm. It's applicable to batch systems, where job length (expected execution time) is known in advance. It could also be modified to be preemptive (e.g. preemption when new job arrives, or existing one unblocks).</p>\n<p>When the CPU is available, it is assigned to the shortest job. Shortest job - shortest <em>execution time</em>. Ties are resolved using FCFS. SJF is similar to FCFS, but ready queue is sorted based on submitted estimate of execution time.</p>\n<p><strong>SJF scheduling</strong></p>\n<!-- TODO -->\n<table>\n<thead>\n<tr>\n<th>Process</th>\n<th>Arrival</th>\n<th>Burst</th>\n<th>Start</th>\n<th>Finish</th>\n<th>Turnaround</th>\n<th>Waiting</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>P1</td>\n<td>0</td>\n<td>6</td>\n<td>0</td>\n<td>6</td>\n<td>6</td>\n<td>0</td>\n</tr>\n<tr>\n<td>P2</td>\n<td>0</td>\n<td>6</td>\n<td>11</td>\n<td>17</td>\n<td>17</td>\n<td>11</td>\n</tr>\n<tr>\n<td>P3</td>\n<td>1</td>\n<td>3</td>\n<td>8</td>\n<td>11</td>\n<td>10</td>\n<td>7</td>\n</tr>\n<tr>\n<td>P4</td>\n<td>2</td>\n<td>8</td>\n<td>17</td>\n<td>25</td>\n<td>23</td>\n<td>15</td>\n</tr>\n<tr>\n<td>P5</td>\n<td>3</td>\n<td>2</td>\n<td>6</td>\n<td>8</td>\n<td>5</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<div class=\"gatsby-highlight\" data-language=\"mermaid-svg\"><pre class=\"language-mermaid-svg\"><code class=\"language-mermaid-svg\">gantt\n    title SJF Scheduling\n    dateFormat  DD-MM-YYYY\n    section CPU</code></pre></div>\n<hr>\n<p><strong>Advantages</strong></p>\n<ul>\n<li>minimum number of context switches</li>\n<li>\n<p>optimal turnaround time if all jobs arrive simultaneously</p>\n<ul>\n<li>minimizes average waiting time</li>\n</ul>\n</li>\n</ul>\n<p><strong>Disadvantages</strong></p>\n<ul>\n<li>requires advance knowledge of how long a job will execute</li>\n<li>\n<p>has a potential for job starvation</p>\n<ul>\n<li>long programs will never get to run if short programs are continuously added</li>\n<li>can be solved by <strong>aging</strong> (increasing a job priority based on how long it has waited) and then sorting ready queue based on priority</li>\n</ul>\n</li>\n</ul>\n<h2>Shortest-remaining-time-next scheduling (SRTN)</h2>\n<p><strong>Shortest-remaining-time-next</strong> is <em>preemptive</em> version of SJF. Next job is picked based on remaining time: <code class=\"language-text\">remaining = (expected execution) - (time spent on CPU)</code>. <strong>SRTN</strong> is similar to RR, but ready queue is a priority queue, sorted based on remaining time. Preemption happens as a result of adding a job.</p>\n<p><strong>Scheduling</strong></p>\n<!-- TODO -->\n<table>\n<thead>\n<tr>\n<th>Process</th>\n<th>Arrival</th>\n<th>Burst</th>\n<th>Start</th>\n<th>Finish</th>\n<th>Turnaround</th>\n<th>Waiting</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>P1</td>\n<td>0</td>\n<td>6</td>\n<td>0</td>\n<td>6</td>\n<td>6</td>\n<td>0</td>\n</tr>\n<tr>\n<td>P2</td>\n<td>0</td>\n<td>6</td>\n<td>11</td>\n<td>17</td>\n<td>17</td>\n<td>11</td>\n</tr>\n<tr>\n<td>P3</td>\n<td>1</td>\n<td>3</td>\n<td>8</td>\n<td>11</td>\n<td>10</td>\n<td>7</td>\n</tr>\n<tr>\n<td>P4</td>\n<td>2</td>\n<td>8</td>\n<td>17</td>\n<td>25</td>\n<td>23</td>\n<td>15</td>\n</tr>\n<tr>\n<td>P5</td>\n<td>3</td>\n<td>2</td>\n<td>6</td>\n<td>8</td>\n<td>5</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<div class=\"gatsby-highlight\" data-language=\"mermaid-svg\"><pre class=\"language-mermaid-svg\"><code class=\"language-mermaid-svg\">gantt\n    title SJF Scheduling\n    dateFormat  DD-MM-YYYY\n    section CPU</code></pre></div>\n<hr>\n<p><strong>Advantages</strong></p>\n<ul>\n<li><strong>optimal turnaround time</strong> even if jobs don't arrive at the same time</li>\n</ul>\n<p><strong>Disadvantages</strong></p>\n<ul>\n<li>requires knowledge of how long a job will execute</li>\n<li>has a potential for job starvation</li>\n<li>needs to consider cost of context switch</li>\n</ul>\n<h2>Multilevel queues</h2>\n<p>Preemptive time-sharing scheduling algorithm that supports process priorities.</p>\n<!-- TODO -->\n<hr>\n<h1>Deadlocks</h1>\n<p>TODO: lec13</p>\n<p><strong>Definitions</strong>:</p>\n<p>A set of processes is deadlocked if:</p>\n<ul>\n<li>Each process in the set is waiting for an event, <em>and</em></li>\n<li>All such events can be caused by another process in the set</li>\n</ul>\n<p>Such event could be anything: resource becoming available, mutex/semaphore/spinlock being unlocked, message arriving.</p>\n<hr>\n<h2>System model</h2>\n<p>System consists of processes and resources:</p>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathdefault\">n</span></span></span></span> processes: <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>P</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><msub><mi>P</mi><mi>n</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_1, P_2, \\ldots, P_n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathdefault\">m</span></span></span></span> resource types: <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>R</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>R</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><msub><mi>R</mi><mi>m</mi></msub></mrow><annotation encoding=\"application/x-tex\">R_1, R_2, \\ldots, R_m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">m</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> (e.g. CPU, memory space, I/O devices)</li>\n<li>Each resource type <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">R_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> has <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>W</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">W_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> instances (e.g. 1 CPU, 5 disks, 3 printers)</li>\n</ul>\n<p>Each process utilizes a resource in the same manner:</p>\n<ol>\n<li>Process <strong>requests</strong> the resource - OS may block process</li>\n<li>Process <strong>uses</strong> the resource - for a finite amount of time</li>\n<li>Process <strong>releases</strong> the resource - may result in unblocking of related process(es)</li>\n</ol>\n<h2>Deadlock - necessary conditions</h2>\n<ul>\n<li><mark><b>mutual exclusion condition</b></mark> - the involved resources must be unshareable (max. one process per resource)</li>\n<li><mark><b>hold and wait condition</b></mark> - a process holding at least one resource is waiting to acquire additional resources</li>\n<li><mark><b>no preemption condition</b></mark> - a resource can be released only by the process holding it (voluntarily)</li>\n<li><mark><b>circular wait condition</b></mark> - there is an ordering of processes <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mo>{</mo><msub><mi>P</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>P</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><msub><mi>P</mi><mi>n</mi></msub><mo>}</mo></mrow><annotation encoding=\"application/x-tex\">\\{P_1, P_2, \\ldots, P_n\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">{</span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">}</span></span></span></span>, such that <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> waits for <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>, <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> waits for <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mn>3</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>, <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mi>n</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> waits for <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>, therefore there is a cycle</li>\n</ul>\n<p>Conditions are also called <strong>Coffman conditions</strong>.</p>\n<h2>Deadlock with mutex locks</h2>\n<p>Deadlocks can occur in many different ways, e.g. due to locking. For example, deadlock with 2 mutexes:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Thread 1</span>\n<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Critical section</span>\n<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Thread 2</span>\n<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Critical section</span>\n<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mutex2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/notes/static/376b0c00bf582fdf2436a10298bf04cf/597c7/lec13-deadlock2-mutexes.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 75.39149888143177%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACNklEQVQ4y31U73OaQBDl//8f+qEf2s500mmnnY6dpEmrSayS2CjSKoKggigHUn4JVsHXA6KBlGRndm7vbu/du8cuDO5tv98fx4PnCwl2ce5pnFryKOeYS42pAjuY4wXoCBrqvQka3AR3og4vCFEk8RiUqbplu93Cskzciga+dlW8+nyFFyen+MbraA80zDU1y6l6HXN84v2CZVlYrVbwPBcsL4Od+GBlF82RBVbx0OJErLIcGyYd4zgpsWVQsJRVGK6Pc9/3wQ1ltPpjtCl4X5CxXj/s/91EFNwsQoBZhxGI7WJurMAPJdheCNN2ShLstpvMH2wP2/FgOQGmOoFu/qEYHjx/DWa6MHE5MPD+exdvak2c91TcSQv6lN1RhqJWSTbfoy8vccHNcXJ+i7dnLBq/lxBnBpjZItfm7KeMdxcdtMYOujJBvNv9V0a55wx5xcj0/VDvUu/hhsaiSijDuYFLXkN7RNAc6GiJJthfCpIkfgIwZ9wVpmgKhJbTlJ5X0RwaEJQ5mCiKsFwuoaoqhNEIhmHAtu3SU6vMcRwQQsBxHERRys4FQVD+yq7rluor1XFhuRgvHMhLN4uTOC7sx9nlpa+cCZ0kOIyEmBmw6zoYzEzUWBGvaz/w8mMdpx0FI22FTRTCoTkpwx3VuohR2SmpDJIkodFT0FFDfGFH+HTF42a6xjU/hUmBivVY6pTnenmi6rjuT1Dvz9BIhecnmGn687381OYh9j0PC4NkHvhe5R+pSOIf/G13bnHVUjsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Deadlock with 2 mutexes\"\n        title=\"\"\n        src=\"/notes/static/376b0c00bf582fdf2436a10298bf04cf/fb8a0/lec13-deadlock2-mutexes.png\"\n        srcset=\"/notes/static/376b0c00bf582fdf2436a10298bf04cf/1a291/lec13-deadlock2-mutexes.png 148w,\n/notes/static/376b0c00bf582fdf2436a10298bf04cf/2bc4a/lec13-deadlock2-mutexes.png 295w,\n/notes/static/376b0c00bf582fdf2436a10298bf04cf/fb8a0/lec13-deadlock2-mutexes.png 590w,\n/notes/static/376b0c00bf582fdf2436a10298bf04cf/526de/lec13-deadlock2-mutexes.png 885w,\n/notes/static/376b0c00bf582fdf2436a10298bf04cf/597c7/lec13-deadlock2-mutexes.png 894w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>All 4 necessary conditions are present: <em>mutual exclusion</em>, <em>hold and wait</em>, <em>no preemption</em>, <em>circular wait</em>.</p>\n<!-- TODO -->\n<h2>Safe, Unsafe, Deadlock State</h2>\n<ul>\n<li>If a system in a <strong>safe state</strong>, then deadlocks are not possible, because they will be avoided by the system.</li>\n<li>If a system is in an <strong>unsafe state</strong>, then deadlocks are possible, but not guaranteed.</li>\n<li>Avoidance algorithm ensures that a system never enters an unsafe state, by rejecting/blocking some requests even if resources are available.</li>\n</ul>\n<h3>Deadlock avoidance algorithms</h3>\n<p>For single instance per resource type, we use <strong>resource-allocation graph algorithm</strong>. For multiple instances per resource, we use <strong>banker's algorithm</strong>.</p>\n<p><strong>Resource-allocation graph algorithm</strong></p>\n<ul>\n<li>\n<p><strong>Claim edge</strong> <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub><mo>→</mo><msub><mi>R</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_i \\to R_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> indicates that process <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> <em>may</em> request resource <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>R</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">R_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span>.</p>\n<ul>\n<li>Represented by a dashed line.</li>\n<li>This is a priori knowledge.</li>\n</ul>\n</li>\n<li>\n<p>Claim edge converts to <strong>request edge</strong> when a process actually requests a resource.</p>\n<ul>\n<li>Represented by a solid line.</li>\n</ul>\n</li>\n<li>\n<p>Request edge converts to an <strong>assignment edge</strong> when the resource is allocated to the process.</p>\n<ul>\n<li>Represented by a solid line, reversed direction.</li>\n</ul>\n</li>\n<li>\n<p>When a resource is released by a process, assignment edge converts to a claim edge.</p>\n<ul>\n<li>Reverse direction &#x26; becomes dashed.</li>\n</ul>\n</li>\n<li>Resources must be claimed <strong>a priori</strong> in the system.</li>\n</ul>\n<p><strong>Algorithm steps</strong>:</p>\n<ul>\n<li>suppose that process requests a resource</li>\n<li>the request can be granted only if allowing such request will not violate <strong>safe state</strong></li>\n<li>we make sure that converting the request edge to an assignment edge does not result in <strong>formation of a cycle</strong></li>\n<li>complexity: same as cycle-detection algorithm in a directed i.e. <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi mathvariant=\"normal\">∣</mi><mi>V</mi><mi mathvariant=\"normal\">∣</mi><mo>+</mo><mi mathvariant=\"normal\">∣</mi><mi>E</mi><mi mathvariant=\"normal\">∣</mi><mo>)</mo></mrow><annotation encoding=\"application/x-tex\">O(|V| + |E|)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\">∣</span><span class=\"mord mathdefault\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord\">∣</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">∣</span><span class=\"mord mathdefault\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord\">∣</span><span class=\"mclose\">)</span></span></span></span></li>\n</ul>\n<p><strong>Banker's algorithm</strong></p>\n<p>Deadlock avoidance algorithm, more general than resource-allocation graph algorithm, but also a bit slower. It works with multiple instances per resource type. Requirements:</p>\n<ul>\n<li>Each process must declare maximum resources at the beginning</li>\n<li>When a process requests a resource, it may have to wait (even if resource available)</li>\n<li>When a process gets all its resources, it must return them in a finite amount of time</li>\n</ul>\n<p><strong>Data structures for the Banker's algorithm</strong>:</p>\n<p>Let <code class=\"language-text\">n</code> = number of processes, and <code class=\"language-text\">m</code> = number of resource types</p>\n<ul>\n<li>\n<p><strong>Available</strong> - vector of length <code class=\"language-text\">m</code></p>\n<ul>\n<li><code class=\"language-text\">Available[j] = k</code> means there are <code class=\"language-text\">k</code> instances of resource type <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>R</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">R_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> available</li>\n</ul>\n</li>\n<li>\n<p><strong>Max</strong> - matrix <code class=\"language-text\">n x m</code></p>\n<ul>\n<li><code class=\"language-text\">Max[i][j] = k</code> means that process <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> may request at most <code class=\"language-text\">k</code> instances of resource type <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>R</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">R_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></li>\n<li><code class=\"language-text\">Max[i]</code> represents i-th row of <code class=\"language-text\">Max</code></li>\n</ul>\n</li>\n<li>\n<p><strong>Allocation</strong> - matrix <code class=\"language-text\">n x m</code></p>\n<ul>\n<li><code class=\"language-text\">Allocation[i][j] = k</code> means that process <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> is currently allocated <code class=\"language-text\">k</code> instances of <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>R</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">R_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></li>\n</ul>\n</li>\n<li>\n<p><strong>Need</strong> - matrix <code class=\"language-text\">n x m</code></p>\n<ul>\n<li><code class=\"language-text\">Need[i][j] = k</code> means that <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> may need <code class=\"language-text\">k</code> more instances of <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>R</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">R_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> to complete its task</li>\n</ul>\n</li>\n<li>Note: <code class=\"language-text\">Need[i][j] = Max[i][j] - Allocation[i][j]</code>. Only 2 of Need/Max/Allocation are needed, the 3rd can be computed on the fly</li>\n</ul>\n<p>Banker's algorithm tries to find whether there is an execution sequence that would finish all running processes, assuming worst case scenario - that each process requests its maximum declared allocation as the next step.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">; Step 1\nInitialize temporary vecors:\nWork = Available                        ; vector copy\nFinish[i] = false for i = 0, 1, n-1\n\n; Step 2\nFind an i such that:\n  Finish[i] = false and Need[i] &lt;= Work ; vector comparison\n\nIf no such i exists:\n  goto step 4\n\n; Step 3\nUpdate Work and Finish:\n  Work = Work + Allocation[i]\n  Finish[i] = true\ngoto step 2\n\n; Step 4\nIf Finish[i] == true for all i, return true ; system is in a safe state\nelse return false                           ; system is not in a safe state</code></pre></div>\n<p><strong>Complexity</strong>: <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>O</mi><mo>(</mo><msup><mi>n</mi><mn>2</mn></msup><mo>∗</mo><mi>m</mi><mo>)</mo></mrow><annotation encoding=\"application/x-tex\">O(n^2 * m)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.064108em;vertical-align:-0.25em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathdefault\">n</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathdefault\">m</span><span class=\"mclose\">)</span></span></span></span></p>\n<h3>Deadlock detection</h3>\n<p>We allow system to enter a <em>deadlocked state</em>, but later we detect the deadlock and recover. Detection algorithm:</p>\n<ul>\n<li>with single instance per resource type</li>\n<li>multiple instances per resource type</li>\n</ul>\n<p><strong>Single instance per resource type</strong></p>\n<p>Maintains an up-to-date <strong>wait-for</strong> graph:</p>\n<ul>\n<li>nodes are <strong>processes</strong></li>\n<li>edge <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub><mo>→</mo><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_i \\to P_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> exists if <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> is waiting for <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></li>\n<li>can be obtained by <strong>collapsing</strong> resource allocation graph</li>\n</ul>\n<p>A cycle-detection algorithm is invoked periodically. If there's a cycle, there exists a deadlock.</p>\n<p><strong>Multiple instances per resource type</strong></p>\n<p>Very similar to Banker's algorithm:</p>\n<ul>\n<li>try to determine if there is a sequence in which running processes can <strong>finish</strong> executing.</li>\n<li>assumes best case scenario - a process that is given its requested resources will finish without asking for more resources, and then releases all its resources.</li>\n<li>does not require <code class=\"language-text\">Max[]</code> or <code class=\"language-text\">Need[]</code>.</li>\n</ul>\n<p>Maintains following:</p>\n<ul>\n<li><code class=\"language-text\">n</code> number of processes</li>\n<li><code class=\"language-text\">m</code> number of resource types</li>\n<li><code class=\"language-text\">Available[m]</code> - indicates the number of available resources of each type</li>\n<li><code class=\"language-text\">Allocation[n][m]</code> - allocation of resources per process</li>\n<li><code class=\"language-text\">Request[n][m]</code> - requests for resources per process</li>\n</ul>\n<p><strong>Algorithm</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1. Initialize:\n  work = available\n  finish[i] = allocation == 0, for all i = 1 .. n\n\n2. Find an index i such that:\n  finish[i] == false and request[i] &lt;= work\n  if doesnt exist, goto step 4\n\n3. work = work + allocation[i]\n   finish[i] = true\n   goto step 2\n\n4. if finish[i] == true for 1 &lt;= i &lt;= n, then the system is not in deadlock.\n   Otherwise, all processes Pi for which finish[i] is false are deadlocked</code></pre></div>\n<h4>Detection algorithms - when and how often?</h4>\n<p>Detection algorithms are expensive, cannot invoke on every resource request. Other ways of invoking detections include checking every few minutes, check when CPU goes idle. When and how often depends on how often a deadlock is likely to occur, how many processes will be affected (one for each disjoint cycle). If we check too often, we spend too many CPU cycles on useless work. If we don't check often enough, there may be many cycles in the resource graph and we would not be able to tell which of the many deadlocked processes caused the deadlock.</p>\n<h3>Deadlock recovery</h3>\n<p>Done via <strong>process termination</strong>, <strong>process rollback</strong> or <strong>resource preemption</strong>.</p>\n<p><strong>Process termination</strong></p>\n<p><strong>Process rollback</strong></p>\n<p><strong>Process preemption</strong></p>\n<hr>\n<h1>Memory</h1>\n<p>TODO: lec14</p>\n<hr>\n<h1>Virtual Memory</h1>\n<p>TODO: lec15</p>\n<hr>\n<h1>Paging</h1>\n<p>TODO: lec16</p>\n<hr>\n<h1>Filesystems</h1>\n<h2>Long term storage</h2>\n<p>Long term storage must store a very large amount of information. Information must survive termination of a process using it. Multiple processes must be able to access information concurrently. Easy way to search and manage stored information should be implemented.</p>\n<h2>Disks <em>without</em> filesystems</h2>\n<p>Think of a disk as a linear sequence of <strong>fixed-sized blocks</strong> that support two operations:</p>\n<ul>\n<li><code class=\"language-text\">read-block i</code></li>\n<li><code class=\"language-text\">write-block i</code></li>\n</ul>\n<p>Similar to memory, however it's <strong>block addressable</strong>, <strong>persistent</strong>, and <strong>much slower</strong>.</p>\n<p>In order to access information, we need a <strong>filesystem</strong> as an abstraction on <code class=\"language-text\">read-block</code> and <code class=\"language-text\">write-block</code>.</p>\n<h2>Files</h2>\n<p>File is an <strong>abstraction</strong> of long term storage, implemented by OS. OS allows processes to see a file through contiguous logical address space. File contains a sequence of bytes, which can be individually addressed. OS maps files onto physical devices and OS (generally) does not care about the content of files.</p>\n<p>File's creator decides on the contents of the file (its format/internal structure). We can construct higher abstractions, e.g. treat files as a sequence of bits, numbers, etc.</p>\n<h3>File attributes</h3>\n<p>Files have contents, but also attributes. <strong>File attributes</strong> vary from one OS to another, but typically consist of these:</p>\n<ul>\n<li>Filename: the symbolic file name is the only information kept in human readable form</li>\n<li>Identifier: unique tag that identifies the file within the FS</li>\n<li>Special type: needed for systems that support different file types (e.g. block device)</li>\n<li>Location: a pointer to the location of the file contents on the device</li>\n<li>Size of the file</li>\n<li>Time/date: time of creation/last modification/last access, used for usage monitoring</li>\n<li>User ID, group ID: identifies owner(s) of the file</li>\n<li>Protection information: access control information (e.g. read/write/execute)</li>\n</ul>\n<p>Many variations, including extended file attributes, such as file checksum. This information is usually kept separate from file contents, for example in the directory structure. This metadata is not stored in the same block as the file data.</p>\n<h3>File naming</h3>\n<p>Names are given to files at creation time, but usually can be changed later as well. Different file-naming rules on different systems:</p>\n<ul>\n<li>maximum filename length</li>\n<li>allowed/restricted characters</li>\n<li>capitalization</li>\n<li>filename extensions, enforced vs conventions</li>\n</ul>\n<h3>Special file types</h3>\n<p>Most systems have <strong>special file types</strong>:</p>\n<ul>\n<li>regular files: both text or binary</li>\n<li>directory: special files for maintaining FS structure</li>\n<li>character special files: for I/O on character devices, <code class=\"language-text\">/dev/random</code></li>\n<li>block special files: for I/O on block devices <code class=\"language-text\">/dev/sda</code></li>\n<li>links: pointers to other files</li>\n<li>sockets, pipes</li>\n</ul>\n<h3>File format (file type)</h3>\n<p>Regular files can have custom types as well, aka <strong>file format</strong> or <strong>file type</strong>. It is determined by the file creator. If OS recognizes the file format, it can operate on the file in reasonable ways, e.g. automatically using an appropriate program to open a file.</p>\n<p>Windows uses file extension to determine a file format. UNIX uses <strong>magic number</strong> technique to determine file format, extension, is only a convention. Format inferred by inspecting the contents of the file, often first few bytes. (e.g. <code class=\"language-text\">#!/usr/bin/env bash</code>).</p>\n<h3>File operations</h3>\n<p>Most systems allow the following operations on regular files:</p>\n<ul>\n<li><code class=\"language-text\">create</code></li>\n<li><code class=\"language-text\">delete</code> - (operation could be on directory)</li>\n<li><code class=\"language-text\">open</code></li>\n<li><code class=\"language-text\">close</code></li>\n<li><code class=\"language-text\">read</code></li>\n<li><code class=\"language-text\">write</code></li>\n<li><code class=\"language-text\">append</code></li>\n<li><code class=\"language-text\">seek</code></li>\n<li><code class=\"language-text\">get attributes</code> - (operation could be on directory)</li>\n<li><code class=\"language-text\">set attributes</code> - (operation could be on directory)</li>\n<li><code class=\"language-text\">rename</code> - (operation could be on directory)</li>\n</ul>\n<h3>Open files</h3>\n<p>OS needs to manage open files, and allow fast access to data in these files. To do this, OS keeps several data structures in memory.</p>\n<ul>\n<li>\n<p><strong>Open-file table</strong>: Tracks open files, per-process tables, and a system-wide table.</p>\n<ul>\n<li><strong>file pointer</strong>: pointer to last read/write location, per process.</li>\n<li><strong>file-open count</strong>: number of times a file is open - to allow removal of data from open-file table when last process closes it, system wide.</li>\n<li>permissions, pointer to file contents, system wide.</li>\n</ul>\n</li>\n</ul>\n<p>OS keeps various information related to filesystems in various data structures (in memory), to make FS management possible as well as to improve performance. Examples:</p>\n<ul>\n<li>system-wide open-file table: entry for each open file, e.g. starting block number</li>\n<li>per-process open-file table: pointers into system-wide open-file table + file pointer</li>\n<li>mount table: information about each monted volume</li>\n<li>buffer cache: caches FS blocks, to reduce the number of raw reads/write to files, to speed up access to frequently accessed directories, etc.</li>\n</ul>\n<h3>Sequential and random file access</h3>\n<p>There are two general types of accessing files: <strong>sequential &#x26; random</strong>. It applies for both reading and writing.</p>\n<p><strong>Sequential access</strong></p>\n<p>Bytes in the file are accessed sequentially, from beginning to end; no skipping, no out-of-order access, although files usually can be rewound.</p>\n<p><strong>Random access</strong></p>\n<p>Bytes can be accessed in any order. Usually implemented via <code class=\"language-text\">seek</code> API.</p>\n<h3>Directories</h3>\n<p>A filesystem is a <em>collection of files</em>, where files are the basic units in a filesystem. <strong>Directories</strong> are used to organize files hierarchically.</p>\n<ul>\n<li>Root node of the tree is the <strong>root directory</strong>.</li>\n<li>Internal nodes = directories, leaf nodes = files.</li>\n<li>Path in a tree = filepath.</li>\n</ul>\n<p>Directory is usually implemented as a special file. Directory file contains <strong>directory entries</strong>. Entry contains file attributes, filename, size, etc. Entries can represent a file or a directory (<em>subdirectory</em>). If subdirectories not allowed, then it is a <strong>single-level directory</strong> system. If subdirectories are allowed, then it is a <strong>hierarchical directory</strong> system.</p>\n<h2>Disk partitions</h2>\n<p>A physical disk can be subdivided into separate regions, called <em>partitions</em>. Partition is an abstraction, creaating illusion that there are more disks. OS can manage partitions independently, as if they were separate disks. Information about partitions is stored in a <em>partition table</em>.</p>\n<h3>Partition and mounting</h3>\n<p>Partition can be formatted to contain a filesystem, it must be mounted to access. Or it can stay raw (unformatted). <strong>Root partition</strong> with a filesystem contains the OS, mounted at a boot time as root directory <code class=\"language-text\">/</code>.</p>\n<h3>Filesystem blocks</h3>\n<p>Filesystems split files up into fixed-sized blocks. File sizes are sized up to the nearest multiple. Most filesystems suffer from internal fragmentation. <strong>Filesystem block</strong> size is usually a multiple <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msup><mn>2</mn><mi>n</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.664392em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">n</span></span></span></span></span></span></span></span></span></span></span> of the underlying <em>disk block</em> size. FS blocks of one file not necessarily adjacent. That results in <strong>fragmented file</strong>, seek time performance issues. Performance and space utilization are inherently in conflict.</p>\n<h2>Virtual file systems</h2>\n<p><strong>Virtual file systems</strong> provide an 'object-oriented' way of implementing file systems. VFS allows the same system call interface (the API) to be used for different file systems. It separates generic file-system operations from implementation details. VFS implementation can be disk filesystem, RAM FS, archive FS, or even network based FS.</p>\n<p>OS accesses all filesystems throught the same VFS interface. </p>\n<p><img src=\"VFS%20Structure\" alt=\"lec17-vfs.png\"></p>\n<h3>VFS Implementation</h3>\n<p>Linux implements VFS through four object types: <code class=\"language-text\">inode</code>, <code class=\"language-text\">file</code>, <code class=\"language-text\">superblock</code>, <code class=\"language-text\">dentry</code>. VFS defines set of operations on the objects that must be implemented:</p>\n<ul>\n<li>Every object has a pointer to a function table</li>\n<li>Function table contains addresses of routines that implement that function on that object</li>\n<li>\n<p>example:</p>\n<ul>\n<li><code class=\"language-text\">int open(...)</code>: open a file</li>\n<li><code class=\"language-text\">int close(...)</code>: close an already-open file</li>\n<li><code class=\"language-text\">ssize_t read(...)</code>: read from a file</li>\n<li><code class=\"language-text\">ssize_t write(...)</code>: write to a file</li>\n<li><code class=\"language-text\">int mmap(...)</code>: memory map a file</li>\n</ul>\n</li>\n</ul>\n<p>A developer of a new FS only needs to implement VFS API. Then the FS can be mounted by Linux.</p>\n<h3>Directory implementation</h3>\n<p><strong>Linear list</strong> of file names with pointer to the file blocks:</p>\n<ul>\n<li>simple to implement</li>\n<li>O(n) search time</li>\n<li>could be maintaned in sorted order</li>\n</ul>\n<p><strong>Hash table</strong> - linear list with <em>hash</em> data structure</p>\n<ul>\n<li>potentially O(1) search time</li>\n<li>needs good hash function to limit collisions, and the right size table</li>\n<li>big table -> a lot of wasted space, small table -> too many collisions</li>\n<li>dynamically resizable hash table could be used to solve this</li>\n</ul>\n<p>Linux (ext3/ext4) uses special data structures called <code class=\"language-text\">htrees</code>.</p>\n<h2>File allocation methods</h2>\n<p>File allocation method refers of how disk blocks are allocated to files.</p>\n<h3>Contiguous allocation</h3>\n<p><strong>Contiguous allocation</strong> - each file occupies a set of <strong>contiguous</strong> blocks. Results in best performance in most cases. Simple - only starting location (block #) and length (number of blocks) are required. Problems include:</p>\n<ul>\n<li>finding space for files</li>\n<li>either knowing file size at creation, or complications with growing a file</li>\n<li>external fragmentation after file deletion</li>\n<li>need for <strong>compaction</strong> offline (downtime) or online (reduced performance), aka <strong>defragmentation</strong>.</li>\n</ul>\n<p>Contiguous allocation is not very common. Useful for tapes &#x26; read-only devices, such as CD-ROMs.</p>\n<p><strong>Allocation process</strong></p>\n<p><img src=\"Contiguous%20allocation%20process\" alt=\"lec17-cont-alloc.png\"></p>\n<p>Mapping from logical to physical address: assuming block size is a power of 2. Logical address: <code class=\"language-text\">[    q  |  r ]</code>, where <code class=\"language-text\">q</code> upper bits, <code class=\"language-text\">r</code> lower bits. Physical address computation:</p>\n<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo>=</mo><mi>q</mi><mo>+</mo><mtext> address of first block</mtext><mspace linebreak=\"newline\"></mspace><mtext>displacement within block </mtext><mo>=</mo><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">block = q + \\text{ address of first block} \\\\\n\\text{displacement within block } = r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathdefault\">b</span><span class=\"mord mathdefault\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathdefault\">o</span><span class=\"mord mathdefault\">c</span><span class=\"mord mathdefault\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7777700000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\"> address of first block</span></span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord text\"><span class=\"mord\">displacement within block </span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span>\n<h3>Linked allocation</h3>\n<p>In <strong>linked allocation</strong> each file is stored in a linked list of blocks. Each block contains file content plus a pointer to the next block. File ends at a block with <code class=\"language-text\">NULL</code> pointer. No external fragmentation -> no compaction needed. Separate free space management needed, e.g. linked list of free blocks. Reliability can be a problem, can lost blocks due to disk failures. <strong>Major problem</strong>: location a block can take many I/Os and disk sees: 1. logical address to physical address mapping requires traversing the list; 2. we could cache the next pointers, but would still need to read entire file first. We could improve efficiency by clustering blocks into larger groups, but that <strong>increases internal fragmentation</strong>.</p>\n<p><strong>Allocation process</strong></p>\n<p><a href=\"Linked%20allocation%20process\">lec17-linked-alloc.png</a></p>\n<p>Example directory entry:</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">filename</th>\n<th align=\"center\">start block</th>\n<th align=\"center\">size</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"><code class=\"language-text\">test.txt</code></td>\n<td align=\"center\">10</td>\n<td align=\"center\">2100</td>\n</tr>\n</tbody>\n</table>\n<p>Contents of <code class=\"language-text\">test.txt</code> spread over blocks: 10, 11, 14, 5, 17. File size entry is needed, because blocks * block size != filesize.</p>\n<h2>File Allocation Table (FAT)</h2>\n<p>FAT (File Allocation Table) is a variation of linked allocation: all next pointers are stored in a separate table (FAT). FAT can be location e.g. at the beginning or end of the FS volume. FAT is indexed by block number, you can think of it as an array: <code class=\"language-text\">fat[N]</code> contains next pointer to block <code class=\"language-text\">N</code>, where <code class=\"language-text\">-1</code> could denote <code class=\"language-text\">NULL</code> pointer. One FAT table for the entire disk. Directory entry contains index into FAT.</p>\n<p>FAT is much like a linked list, but because all pointers stored together, FAT is faster and cache-able. Easier random acces compare to linked allocation. Issues with FAT:</p>\n<ul>\n<li>the entire table must be in memory at all times to achieve efficient random access</li>\n<li>table can be quite big for large disks</li>\n</ul>\n<h3>Index Allocation (inodes)</h3>\n<p>Basic idea behind <strong>index allocation</strong> is to store a per-file FAT-like structure, then we don't need to cache pointers for all files, only the open files. Each file has its own index block(s) called <code class=\"language-text\">inode</code>s. An <code class=\"language-text\">inode</code> block contains:</p>\n<ul>\n<li>direct pointers to blocks with file contents, or more indirect pointers to even more <code class=\"language-text\">inode</code>s.</li>\n<li>\n<p>optionally, <code class=\"language-text\">inode</code> can contain various file attributes:</p>\n<ul>\n<li>file size in bytes, device ID, owner, permissions, timestamps, link count</li>\n<li><code class=\"language-text\">inode</code> <strong>does not</strong> contain a filename</li>\n</ul>\n</li>\n</ul>\n<p><code class=\"language-text\">dentry</code> is used to associate filename with <code class=\"language-text\">inode</code>. <code class=\"language-text\">dentry = filename + inode*</code>. Possible to have different filenames associated with the same <code class=\"language-text\">inode</code>, called <strong>hard links</strong> (<code class=\"language-ln <src\"> &lt;target</code>).</p>\n<p><strong>inodes in Linux (ext2)</strong></p>\n<p>Example: block size 1KB, block address 4 bytes. Single inode with 12 direct entries, max file size 12KB. If we add a single indirect pointer to inode: 1KB block can have 1KB/4B = 256 entries =. max file sisze 256 + 12 blocks = 268KB. Adding double indirect pointer as well: or 256 blocks each with 256 addresses -> max file size: <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msup><mn>2</mn><mn>16</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^{16}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">6</span></span></span></span></span></span></span></span></span></span></span></span> blocks ~= 64MB. Adding triple indirect pointer -> max file size: <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msup><mn>2</mn><mn>24</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^{24}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mord mtight\">4</span></span></span></span></span></span></span></span></span></span></span></span> blocks ~= 16GB. ext3 max file size = 2TB. ext4 max file size = 16TB (using 48 bit addresses).</p>\n<hr>\n<p><strong>Advantages</strong>:</p>\n<ul>\n<li>random access is reasonable: only need to keep the inodes for opened files in memory</li>\n<li>file size is not limited (practically)</li>\n<li>file can have holes</li>\n</ul>\n<p><strong>Disadvantages</strong>:</p>\n<ul>\n<li>at least one additional block is required for each file</li>\n</ul>\n<h3>Hard link vs. soft link</h3>\n<ol>\n<li>create <code class=\"language-text\">file.txt</code>: <code class=\"language-echo \"yo\" \"> file.txt</code></li>\n<li>create <strong>hard link</strong>: <code class=\"language-text\">ln file.txt file_hard_link.txt</code>. A hard link points to the same <code class=\"language-text\">inode</code>, if we delete <code class=\"language-text\">file.txt</code>, <code class=\"language-text\">file_hard_link.txt</code> will still work.</li>\n<li>create <strong>soft link</strong>: <code class=\"language-text\">ln -s file.txt file_soft_link.txt</code>. Deleting <code class=\"language-text\">file.txt</code> breaks <code class=\"language-text\">file_soft_link.txt</code>.</li>\n</ol>\n<p>Hard links can be created only to regular files; can't hard-link directories, it <strong>could lead to cycles in FS</strong>. Symbolic links can link to anything, can lead to cycles and broken links too (<code class=\"language-text\">ln -s file.txt file.txt</code>).</p>\n<h3>Performance</h3>\n<p>CPU still outperforms I/O operations, whether done via HDDs or SSDs. Important to try to minimize the number of I/O operations: try to group and combine reads//writes.</p>\n<h2>Free space management - bimaps</h2>\n<p>File systems maintain free-space list to track available blocks. Can be implemented as a bit vector or <strong>bitmap</strong>. OS can reserve some blocks for the bitmap. Example:</p>\n<ul>\n<li>block size = 4KiB = <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msup><mn>2</mn><mn>12</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^{12}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span> bytes</li>\n<li>disk size = 1TiB = <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msup><mn>2</mn><mn>40</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^{40}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">4</span><span class=\"mord mtight\">0</span></span></span></span></span></span></span></span></span></span></span></span> bytes</li>\n<li>total number of blocks = <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msup><mn>2</mn><mn>40</mn></msup><mi mathvariant=\"normal\">/</mi><msup><mn>2</mn><mn>12</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^{40}/2^{12}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.064108em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">4</span><span class=\"mord mtight\">0</span></span></span></span></span></span></span></span></span><span class=\"mord\">/</span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span> = <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msup><mn>2</mn><mn>28</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^{28}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mord mtight\">8</span></span></span></span></span></span></span></span></span></span></span></span> blocks</li>\n<li>we need <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msup><mn>2</mn><mn>28</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^{28}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mord mtight\">8</span></span></span></span></span></span></span></span></span></span></span></span> bits in bitmap = <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msup><mn>2</mn><mn>25</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^{25}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span></span> bytes = 32MiB bitmap or <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msup><mn>2</mn><mn>13</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^{13}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">3</span></span></span></span></span></span></span></span></span></span></span></span> reserved blocks</li>\n<li>if using clusters of 4 blocks instead -> only <span class=\"katex\"><span class=\"katex-mathml\"><math><semantics><mrow><msup><mn>2</mn><mn>11</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^{11}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span></span></span></span> reserved blocks</li>\n</ul>\n<p><strong>Cons</strong>: requires searching the bitmap to find free space, wastes some blocks. <strong>Pros</strong>: fairly straightforward to obtain contiguous blocks.</p>\n<hr>\n<p><img src=\"Free%20space%20linked%20list\" alt=\"lec17-free.png\"></p>\n<p><strong>Linked free space list</strong>: free list, all free blocks are linked together, pointers stored inside the blocks. Pros: no waste of space, cons: cannot get contiguous space easily.</p>\n<hr>\n<ul>\n<li>\n<p><strong>Grouping</strong></p>\n<ul>\n<li>instead of storing just one pointer, utilize the space of the entire free block</li>\n<li>store address of next n - 1 free blocks in first free block, plus a pointer to next blok that contains more free-block-pointer</li>\n</ul>\n</li>\n<li>\n<p><strong>Counting</strong></p>\n<ul>\n<li>takes advantage of the fact that space is frequently contiguously used and freed</li>\n<li>keep address of first free block plus the count of following free blocks</li>\n<li>free list then has entries containing addresses and counts</li>\n</ul>\n</li>\n<li>\n<p><strong>Space maps</strong></p>\n<ul>\n<li>divides device space into metaslab units, each representing a chunk of manageable size</li>\n<li>within each metaslab, a counting algorithm is used to keep track of free space</li>\n</ul>\n</li>\n</ul>\n<h2>File locking</h2>\n<p>Provided by some operating systems and/or filesystems. Similar to reader-writer locks. <strong>Shared lock</strong> similar to reader lock - several processes can acquire concurrently. <strong>Exclusive lock</strong> similar to writer lock. Mediates access to a file to multiple processes during <code class=\"language-text\">open()</code>. Types: 1. <strong>mandatory</strong> - access is denied, depending on locks held and requested. 2. <strong>advisory</strong> - preocesses can find status of locks and decide what to do.</p>\n<hr>\n<h1>Disks, Scheduling, RAID</h1>\n<h2>Magnetic disks</h2>\n<p>Each disk <strong>platter</strong> has a flat circular shape. Platters rotate 5400 - 15000 RPMs, the <strong>read-write heads</strong> fly just above the surface of each platter. <strong>Head crash</strong>: the head makes contact with the disk surface, causing permanent damage to the disk. Each head is attached to a disk arm that moves all heads at the same time.</p>\n<h3>Disk space</h3>\n<p>The surface of a platter is logically divided into <strong>circular tracks</strong></p>\n<ul>\n<li>each track is further divided into <strong>sectors</strong></li>\n<li>the set of tracks that are at the same arm position make up a <strong>cylinder</strong></li>\n</ul>\n<p><img src=\"Space\" alt=\"lec18-sectors.png\"></p>\n<h3>Mapping</h3>\n<p>A <strong>logicak block</strong> is the smallest unit of transfer between the disk and the memory, e.g. 512 bytes. Software accesses data on disks oly using <code class=\"language-text\">write(block #)</code> and <code class=\"language-text\">read(block #)</code>. <strong>Mapping</strong> is a process of convering a logical block number into physical address that consists of a cylinder number, a head number, and a sector number. The sectors on disk are mapped to large one-dimensional arrays of logical blocks, numbered consecutively. On modern disks this mapping is done by an embedded controller due to complicated geometry.</p>\n<p><strong>Low level format</strong></p>\n<p><strong>Low level format</strong> or <strong>physical format</strong> writes low level information to the disk, dividing it into series of tracks, each containing some number of sectors, with small gaps between sectors.</p>\n<p><img src=\"Low%20level%20format\" alt=\"lec18-low-level-format.png\"></p>\n<ul>\n<li>Preamble: starts with a special bit sequence, cylinder number, sector number, etc.</li>\n<li>Data: depends on the format (e.g. 512 bytes)</li>\n<li>Error correction code: redundant information to detect read errors.</li>\n</ul>\n<p>The formattet capacity is about 20% <strong>lower</strong> than the unformatted capacity.</p>\n<h2>Disk management</h2>\n<p>In order to use a disk to hold files, the OS needs to record data structures on the disk. <strong>Partition</strong> the disk into one or more regions, each treated as a logical disk. <strong>Logical formatting</strong> or \"making a file sysem\" on a partition: abstracting blocks into files and directories.</p>\n<p>OS can allow raw disk access for applications that want to do their own block management, and want to keep OS out of the way (e.g. databases). Methods such as <strong>sector sparing</strong> can be used to handle bad blocks, either at OS level, or at lower level.</p>\n<h2>Disk scheduling</h2>\n<p>The time required for reading or writing a disk block is determined by several factors. The must important is <strong>seek time</strong> - the time to move the arm holding the heads to the correct cylinder.</p>\n<p>The requests for disk I/O are appended to the <strong>disk queue</strong>. OS maintains separate queues of requests for <strong>each disk</strong>. OS can improve the overall I/O performance by reordering disk I/O requests, with the goal of <strong>minimizing the total head movement</strong>.</p>\n<h3>FCFS Scheduling</h3>\n<p><strong>First come first serve</strong> scheduling processes requests in the same order as they received. It is fair, but it does not provide fasted overall service.</p>\n<p><img src=\"FCFS%20Scheduling\" alt=\"lec18-fcfs.png\"></p>\n<h3>SSTF Scheduling</h3>\n<p><strong>Shortest seek time first</strong> selects the next request that would result in the shortest seek time from the current head position, i.e. picks the closest request next. Seek time = distance to move the heads. May cause starvation of some requests.</p>\n<p><img src=\"SSTF%20Scheduling\" alt=\"lec18-sstf.png\"></p>\n<h3>Elevator Scheduling</h3>\n<p><strong>SCAN</strong></p>\n<p>The head continuously scans back and forth across the disk and serves the requests as it reaches each cylinder. Head moves all the way to first/lst cylinder before turning back. Requests at either end tend to wait the longest.</p>\n<p><img src=\"SCAN\" alt=\"lec18-scan.png\"></p>\n<p><strong>LOOK</strong></p>\n<p>Nearly identical to SCAN, but head does not move al the way to first/last cylinder before turning back. Instead, it only goes as far as necessary. Results in same request order as SCAN, but less overall head movement. </p>\n<p><strong>C-SCAN</strong></p>\n<p>Same as SCAN in one direction, but after reaching last cylinder head repositions to the first cylinder, and no requests are processed during this ime. Achieves more uniform wait time than SCAN.</p>\n<p><strong>C-LOOK</strong></p>\n<p>Small optimization of C-SCAN, head only goes as far as needed by the next request (same optimization as SCAN -> LOOK).</p>\n<p><img src=\"Elevator%20scheduling%20methods\" alt=\"lec18-elevator.png\"></p>\n<hr>\n<p>The performance of a scheduling algorithm depends on:</p>\n<ul>\n<li>the number and types of requests</li>\n<li>the file allocation method</li>\n<li>the location of directories and index blocks</li>\n</ul>\n<p>Either SSTF or LOOK is a reasonable choince for default algorithm, C-LOOK if we need more consistent wait times. Other scheduling algorithms also consider: rotational latency, priority of the task - requests belonging to higher priority process receive higher priority, prioritize read over write, sicnce read requests usually block processes.</p>\n<hr>\n<h2>RAID</h2>\n<p><strong>RAID</strong> - Redundant array of independent disks. Main concept of RAID is providing <em>reliability via redundancy</em>. It can also <strong>improve performance</strong> through parallelization or requests. RAID is accessed as one big disk, therefore there is <strong>increased capacity</strong>. It can be implemented via dedicated hardware, or in software, or a combination. RAID is opposite of partitioning, representing multiple disks as a single disk.</p>\n<h3>RAID 0 - Striped volume</h3>\n<ul>\n<li>Uses a group of disks as one unit.</li>\n<li>Purpose: highest performance for read &#x26; write.</li>\n<li>Consecutive logical blocks distributed across all disks, ideally contents of every file are evenly distributed across all disks.</li>\n<li>Offers no redundancy - a single disk failure leads to entire RAID failure, actually <strong>reduces reliability</strong>.</li>\n<li>With N disks, read &#x26; write performance can be up to N times higher than a single disk, because both read &#x26; write can be parallelized.</li>\n<li>Often used for high-performance temporary storage, where data loss is tolerable.</li>\n</ul>\n<h3>RAID 1 - Mirrored disks</h3>\n<ul>\n<li>Keeps 1 or more duplicates of a disk.</li>\n<li>Purpose: very high reliability &#x26; fast read performance.</li>\n<li>\n<p>With N disks, it is tolerant to N - 1 simultaneous disk failures</p>\n<ul>\n<li>RAID continues to work in <strong>degraded mode</strong></li>\n<li>RAID software usually notifies the operator</li>\n<li>Failed disk can be removed &#x26; <strong>rebuilt</strong> from the surviving disks</li>\n</ul>\n</li>\n<li>With N disks, read performance can be up to N times higher than with a single disk</li>\n<li>Write performance is that of a single disk</li>\n<li>With N disks, only 1 disk worth of space to store data</li>\n</ul>\n<h3>RAID 4 - Striping with dedicated parity</h3>\n<p><img src=\"RAID4\" alt=\"lec18-raid4.png\"></p>\n<ul>\n<li>One disk dedicated to contain <strong>parity</strong> information, computed e.g. using XOR</li>\n<li>Purpose: reliability &#x26; fast read performance</li>\n<li>Tolerant of a single disk failure</li>\n<li>With N disks, only N - 1 are used for data</li>\n<li>\n<p>Not common:</p>\n<ul>\n<li>Write is slow, since parity disk is a bottleneck</li>\n<li>Parity disk also wears out faster than the other disks in the array</li>\n</ul>\n</li>\n</ul>\n<h3>RAID 5 - Striping with distributed parity</h3>\n<p><img src=\"RAID5\" alt=\"lec18-raid5.png\"></p>\n<ul>\n<li>Similar to RAID 4 but parity is <strong>distributed among all disks</strong>.</li>\n<li>Purpose: Reliability, fast read and write performance, but not as fast as RAID 0</li>\n<li>Tolerant of a single disk failure</li>\n<li>WIth N disks, only N - 1 space is used for data</li>\n<li>Common when both performance and redundancy is needed</li>\n</ul>\n<h3>RAID 6 - Striping with double distributed parity</h3>\n<p><img src=\"RAID6\" alt=\"lec18-raid6.png\"></p>\n<ul>\n<li>Similar to RAID 5, but doubles the amount of partity (more complicated than XOR)</li>\n<li>Purpose: reliability, fast read/write performance</li>\n<li>Tolerant of 2 simultaneous disk failures</li>\n<li>With N disks, only N - 2 space is used for data</li>\n<li>Usage: same as RAID 5, but when data is very important</li>\n</ul>\n<h3>RAID 1 + 0 - Striped mirrors</h3>\n<p><img src=\"RAID10\" alt=\"lec18-raid10.png\"></p>\n<ul>\n<li>\n<p>aka RAID 10 is an example of hybrid/nested RAID</p>\n<ul>\n<li>Nests RAID 1 in RAID 0 configuration</li>\n<li>Simplest form: 4 disks, 2 groups of 2</li>\n</ul>\n</li>\n<li>Purpose: very fast &#x26; very reliable. Combines advantages of RAID 0 and RAID 1.</li>\n<li>In simplest form, it can survive a least 1 disk failure.</li>\n<li>Common for high-performance uses where data cannot be lost (databases)</li>\n<li>Cant tune redundancy to 3, 4, 5 simultaneous failures.</li>\n</ul>\n<p>Consider RAID 10 that has N groups of RAID 1 and each group has M disks, i.e. total number of disks = M * N. It can survive at least M - 1 simultaneous disk failures, but potentially up to N(M - 1) failures. Read performance potentially up to N * M of a single disk, write performance is N times higher. Only N disks worth of space are used for data out of N * M, so it's very expensive RAID. Other nested RAIDs are possible: RAID 5+0, RAID 6+0, RAID 10+0.</p>","frontmatter":{"date":"April 22, 2019","title":"CPSC457: Notes","tags":["cpsc457"]}}},"pageContext":{"prev":{"fields":{"slug":"/cpsc457/lec11-more-synchronization"},"frontmatter":{"published":true,"tags":["cpsc457"]}},"slug":"/cpsc457/notes","next":null,"category":"cpsc457"}}