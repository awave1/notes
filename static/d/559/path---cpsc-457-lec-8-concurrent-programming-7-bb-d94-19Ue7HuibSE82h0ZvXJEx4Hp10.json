{"data":{"markdownRemark":{"html":"<h2>Threads and <code class=\"language-text\">fork()</code></h2>\n<p>When <code class=\"language-text\">fork()</code> is called in a program with multiple threads. What happens is only the calling thread survives, other threads are not duplicated. This creates a problem if synchronization mechanisms used. It's possible to register a callback in case <code class=\"language-text\">fork()</code> is called using <code class=\"language-text\">pthread_atfork()</code>. However, generally <strong><code class=\"language-text\">fork()</code> should be avoided</strong> in programs with multiple threads.</p>\n<p>Some usages are sage: e.g.:</p>\n<ul>\n<li><code class=\"language-text\">fork()</code> is immediately followed by <code class=\"language-text\">execve()</code> to execute external program</li>\n<li><code class=\"language-text\">fork()</code> is executed before creating any threads</li>\n</ul>\n<h2>Thread cancellation</h2>\n<p>Imagine a scenario when threads are used to parallelize database search. Multiple threads are searching different parts of the database. If one thread finds the result, how do we notify the other threads to stop searching?</p>\n<p>There are two general approaches:</p>\n<ul>\n<li>Asynchronous cancellation</li>\n<li>Deferred cancellation (aka synchronous cancellation)</li>\n</ul>\n<h3>Async cancellation</h3>\n<p>It's called async because there is no sync with thread that needs to be cancelled, as soon as the signal is received (so data might be missing)</p>\n<p>One thread manually terminates the target thread using <code class=\"language-text\">pthread_kill(thread_id, SIGUSR1)</code> and then target is killed instantly.</p>\n<p>Common problem is what happens to the data currently updated by the thread that is killed?</p>\n<ul>\n<li>Killed thread has no chance to clean up</li>\n<li>This can likely lead to leaving data in undefined state</li>\n</ul>\n<p>Usually, it is better to use synchronous thread cancellation.</p>\n<h3>Deferred / Synchronous Thread Cancellation</h3>\n<p>Controlling thread <strong>indicates</strong> it wishes to cancel a thread. Can be done via some global flag or <code class=\"language-text\">pthread_cancel()</code>. Target thread periodically checks whether it should terminate, checking done only at <strong>cancellation points</strong> at which a thread can be cancelled safely.</p>\n<p>Issues:</p>\n<ul>\n<li>Less performance</li>\n<li>Target thread will not react immediately</li>\n</ul>\n<h2>Race Conditions</h2>\n<p>Race condition is a behavior where the output is dependent on the sequence of timing or other uncontrollable events (e.g. context switching, scheduling on multiple CPUs). Often a result of multiple processes/threads operating on a shared state/resource, e.g.:</p>\n<ul>\n<li>modifying shared memory</li>\n<li>reading/writing to files</li>\n<li>modifying filesystems</li>\n<li>reading/writing to databases</li>\n</ul>\n<p>Let's take the following code for example</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Global variable counter</span>\n<span class=\"token keyword\">int</span> counter<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">incr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// This function is assumes that this is atomic (not interfered by anyone else)</span>\n  <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> counter<span class=\"token punctuation\">;</span>\n  x<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  counter <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> incr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> incr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pthread_join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\\n\"</span><span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>One possible <strong>execution sequence</strong>, leading to <code class=\"language-text\">counter = 2</code></p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"><strong>Thread 1</strong></th>\n<th align=\"center\"><strong>Thread 2</strong></th>\n<th align=\"center\"><strong><code class=\"language-text\">counter</code></strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">x = counter;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">x++;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">counter = x;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">x = counter;</code></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">x++;</code></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">counter = x;</code></td>\n<td align=\"center\"><code class=\"language-text\">2</code></td>\n</tr>\n</tbody>\n</table>\n<p>Another possible execution sequence leading to <code class=\"language-text\">counter = 1</code></p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"><strong>Thread 1</strong></th>\n<th align=\"center\"><strong>Thread 2</strong></th>\n<th align=\"center\"><strong><code class=\"language-text\">counter</code></strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">x = counter;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">x = counter;</code></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">x++;</code></td>\n<td align=\"center\"><code class=\"language-text\">0</code></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">counter = x;</code></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">x++;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">counter = x;</code></td>\n<td align=\"center\"></td>\n<td align=\"center\"><code class=\"language-text\">1</code></td>\n</tr>\n</tbody>\n</table>\n<p>Debugging race conditions is hard, in some rare situations the output might be different, e.g. when system was less/more busy.</p>\n<h3>Avoiding Race Conditions</h3>\n<p>We need to prevent more than one process/thread from accessing the shared resource at any given time. One approach is:</p>\n<ul>\n<li>identify <strong>critical sections</strong> in code where this could happen</li>\n<li>enforce <strong>mutual exclusion</strong> to make sure it does not happen</li>\n</ul>\n<h4>Critical Sections and Mutual Exclusion</h4>\n<p><mark>Critical section/critical region</mark> is a part of the program that accesses the shared resource in a way that could lead to races or other undefined/unpredictable/unwanted behavior:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> counter<span class=\"token punctuation\">;</span> <span class=\"token comment\">// shared resource</span>\n\n<span class=\"token comment\">/**\n * Critical section\n */</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">incr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> counter<span class=\"token punctuation\">;</span>\n  x<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  counter <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If we can arrange tasks such that no two processes or threads will ever be in their critical sections at the same time, we could avoid the race condition, therefore achieving <mark>mutual exclusion</mark>.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/50265a3714c3e5a9886f001256433e03/ed3b0/lec8-critical-sections-mutual-exclusion.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 50.54794520547945%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABQElEQVQoz4VSCW6DMBDk/18EKYEKGsA24TCXga1nEqeoStSVVoY9Z8aOjuOQvw5b11XmeaZP0yTbtjHunGNsWRaej/hvXyRvbN93ae936bqObkzDGKwxhv93n1e14uBgGBphe9u2TFhrieYry6QovkUpLXVd06uqkizNpPcLiHocWTv6c+h7xogQ1IACVAAfSLhdKbndbqK1Zh4x49EFagCAgS+pngzeUsaSJwk/rJXL5epRKi4jUs9gGAb+F0UhV59fV/d5YNAFNLRWksSJNE0jvadmtCFaDIRUiOHfucelRdCtLEuxXgvoYQfLZsRBGd/hRuM49mgvkue5JElCdMih76UhYEM/nMFRAD1RBMHTNOXFIA45UA/9MAz1Qft/NcSJwvPbDIYhGHw2PptPDzu8x4delrfeec1C43nIue8HW80KzcPk0a4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Critical Sections and Mutual Exclusion\"\n        title=\"\"\n        src=\"/static/50265a3714c3e5a9886f001256433e03/623ee/lec8-critical-sections-mutual-exclusion.png\"\n        srcset=\"/static/50265a3714c3e5a9886f001256433e03/816c5/lec8-critical-sections-mutual-exclusion.png 148w,\n/static/50265a3714c3e5a9886f001256433e03/c766b/lec8-critical-sections-mutual-exclusion.png 295w,\n/static/50265a3714c3e5a9886f001256433e03/623ee/lec8-critical-sections-mutual-exclusion.png 590w,\n/static/50265a3714c3e5a9886f001256433e03/e5345/lec8-critical-sections-mutual-exclusion.png 885w,\n/static/50265a3714c3e5a9886f001256433e03/7a439/lec8-critical-sections-mutual-exclusion.png 1180w,\n/static/50265a3714c3e5a9886f001256433e03/ed3b0/lec8-critical-sections-mutual-exclusion.png 1460w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<hr>\n<p>Requirements to avoid race conditions:</p>\n<ul>\n<li>No two processes may be simultaneously inside their critical sections</li>\n<li>No assumptions may be made about the speeds or the number of CPUs</li>\n<li>No process running outside its critical region may block other processes</li>\n<li>\n<p>No process should have to wait forever to enter its critical section</p>\n<ul>\n<li>a process should not remain in a critical section forever</li>\n</ul>\n</li>\n</ul>","frontmatter":{"date":"February 07, 2019","title":"Concurrent Programming","tags":["cpsc457"]}}},"pageContext":{"prev":{"fields":{"slug":"/cpsc457/lec7-threads"},"frontmatter":{"published":true,"tags":["cpsc457"]}},"slug":"/cpsc457/lec8-concurrent-programming","next":{"fields":{"slug":"/cpsc413/midterm-overview"},"frontmatter":{"published":true,"tags":["cpsc413"]}},"category":"cpsc457"}}